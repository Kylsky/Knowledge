# 1.Nginx架构设计的关键约束

## 1.1 性能

### 1.1.1网络性能

这 里 的 网 络 性 能 不 是 针 对 一 个 用 户 而 言 的， 而 是 针 对 Nginx 服 务 而 言 的。 网 络 性 能 是 指 在 不 同 负 载 下， Web 服 务 在 网 络 通 信 上 的 吞 吐 量。 而 带 宽 这 个 概 念， 就 是 指 在 特 定 的 网 络 连 接 上 可 以 达 到 的 最 大 吞 吐 量。 因 此， 网 络 性 能 肯 定 会 受 制 于 带 宽， 当 然 更 多 的 是 受 制 于 Web 服 务 的 软 件 架 构。

### 1.1.2 单次请求的延时性

nginx在设计时应考虑高并发下如何保持平均时延性

### 1.1.3 网络效率

使用网络的效率。如长连接代替短链接，使用压缩算法，使用缓存。



## 1.2 可伸缩性

指架构可以通过添加组件来提升服务，或与组件之间具有交互功能。可以通过组件简化，降低组件间的耦合度，将服务分散到许多组件等方法来改删可伸缩性。可伸缩性受到组件间的交互频率以及组件对一个请求是使用同步还是异步的方式来处理等条件制约。



## 1.3 简单性

简 单 性 通 常 指 组 件 的 简 单 程 度， 每 个 组 件 越 简 单， 就 会 越 容 易 理 解 和 实 现， 也 就 越 容 易 被 验 证（ 被 测 试）。 一 般， 我 们 通 过 分 离 **关 注 点 原 则** 来 设 计 组 件， 对 于 整 体 架 构 来 说， 通 常 使 用 通 用 性 原 则， 统 一 组 件 的 接 口， 这 样 就 减 少 了 架 构 中 的 变 数。



## 1.4  可修改性

修 改 性 就 是 在 当 前 架 构 下 对 于 系 统 功 能 做 出 修 改 的 难 易 程 度， 对 于 Web 服 务 器 来 说， 它 还 包 括 动 态 的 可 修 改 性， 也 就 是 部 署 好 Web 服 务 器 后 可 以 在 不 停 止、 不 重 启 服 务 的 前 提 下， 提 供 给 用 户 不 同 的、 符 合 需 求 的 功 能。 可 修 改 性 可 以 进 一 步 分 解 为 可 进 化 性、 可 扩 展 性、 可 定 制 性、 可 配 置 性 和 可 重 用 性

### 1.4.1 可进化性

可进化性表示修改一个组件时，对其他组件产生的负面影响的程度。越是核心的组件，其可进化性可能会越低。进化这个概念按照服务是否在运行中又可以分为静态进化和动态进化。

优 秀 的 静 态 进 化 主 要 依 赖 于 架 构 的 设 计 是 否 足 够 抽 象， 而 动 态 进 化 则 不 然， 它 与 整 个 服 务 的 设 计 都 是 相 关 的。

### 1.4.2 可扩展性

表示将一个新的功能添加到系统中的能力。除了静态可扩展性外，还有动态可扩展性。

### 1.4.3 可定制性

指可以临时性地重新规定一个组件的特性，从而提供一种非常规服务的能力。如nginx可以通过配置不同的模块定制不同的服务。

### 1.4.4 可配置性

在web服务部署后，通过对服务提供的配置文件进行修改，来提供不同的功能。

### 1.4.5 可重用性

可 重 用 性 指 的 是 一 个 应 用 中 的 功 能 组 件 在 不 被 修 改 的 情 况 下， 可 以 在 其 他 应 用 中 重 用 的 程 度。



## 1.5 可见性

在 Web 服 务 器 这 个 应 用 场 景 中， 可 见 性 通 常 是 指 一 些 关 键 组 件 的 运 行 情 况 可 以 被 监 控 的 程 度。 例 如， 服 务 中 正 在 交 互 的 网 络 连 接 数、 缓 存 的 使 用 情 况 等。 通 过 这 种 监 控， 可 以 改 善 服 务 的 性 能， 尤 其 是 可 靠 性。



## 1.6 可移植性

指跨平台能力



## 1.7 可靠性

可 靠 性 可 以 看 做 是 在 服 务 出 现 部 分 故 障 时， 一 个 架 构 容 易 受 到 系 统 层 面 故 障 影 响 的 程 度。 可 以 通 过 以 下 方 法 提 高 可 靠 性： 避 免 单 点 故 障、 增 加 冗 余、 允 许 监 视， 以 及 用 可 恢 复 的 动 作 来 缩 小 故 障 的 范 围。



# 2.Nginx架构设计

## 2.1 模块化设计

nginx的所有模块都遵循同样的ngx_module_t接口设计规范。

示， ngx_module_t 结 构 体 作 为 所 有 模 块 的 通 用 接 口， 它 只 定 义 了了 init_master、 init_module、 init_process、 init_thread、 exit_thread、 exit_process、 exit_master 这 7 个 回 调 方 法（ 事 实 上， init_master、 init_thread、 exit_thread 这 3 个 方 法 目 前 都 没 有 使 用）， 它 们 负 责 模 块 的 初 始 化 和 退 出， 同 时 它 们 的 权 限 也 非 常 高， 可 以 处 理 系 统 的 核 心 结 构 体 ngx_cycle_t。 

除 了 简 单、 基 础 的 接 口， ngx_module_t 中 的 ctx 成 员 还 是 一 个 void* 指 针， 它 可 以 指 向 任 何 数 据， 这 给 模 块 提 供 了 很 大 的 灵 活 性， 使 得 下 面 将 要 介 绍 的 多 层 次、 多 类 型 的 模 块 设 计 成 为 可 能。 ctx 成 员 一 般 用 于 表 示 在 不 同 类 型 的 模 块 中 一 种 类 型 模 块 所 具 备 的 通 用 性 接 口。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303150948488.png" alt="image-20210303150948488" style="zoom: 50%;" />

nginx的官方核心模块游6个，分别是ngx_core_module\ngx_errlog_module、ngx_events_module、ngx_openssl_module、ngx_http_module、ngx_mail_module

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303151314402.png" alt="image-20210303151314402" style="zoom:50%;" />



## 2.2 事件驱动架构

所 谓 事 件 驱 动 架 构， 简 单 来 说， 就 是 由 一 些 事 件 发 生 源 来 产 生 事 件， 由 一 个 或 者 多 个 事 件 收 集 器 来 收 集、 分 发 事 件， 然 后 许 多 事 件 处 理 器 会 注 册 自 己 感 兴 趣 的 事 件， 同 时 会“ 消 费” 这 些 事 件。 对 于 Nginx 这 个 Web 服 务 器 而 言， 一 般 会 由 网 卡、 磁 盘 产 生 事 件， 事 件 模 块 将 负 责 事 件 的 收 集、 分 发 操 作， 而 所 有 的 模 块 都 可 能 是 事 件 消 费 者， 它 们 首 先 需 要 向 事 件 模 块 注 册 感 兴 趣 的 事 件 类 型， 这 样， 在 有 事 件 产 生 时， 事 件 模 块 会 把 事 件 分 发 到 相 应 的 模 块 中 进 行 处 理。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303151947579.png" alt="image-20210303151947579" style="zoom:50%;" />



## 2.3 请求的多阶段异步处理

多 阶 段 异 步 处 理 请 求 与 事 件 驱 动 架 构 是 密 切 相 关 的， 换 句 话 说， 请 求 的 多 阶 段 异 步 处 理 只 能 基 于 事 件 驱 动 架 构 实 现。 什 么 意 思 呢？ 就 是 把 一 个 请 求 的 处 理 过 程 按 照 事 件 的 触 发 方 式 划 分 为 多 个 阶 段， 每 个 阶 段 都 可 以 由 事 件 收 集、 分 发 器 来 触 发。

处理一个获取静态文件的http请求可以分为以下几个阶段：

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303152438280.png" alt="image-20210303152438280" style="zoom:50%;" />



## 2.4 管理进程、多工作进程设计

nginx采用一个master管理进程、多个worker工作进程的设计方式。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303161958842.png" alt="image-20210303161958842" style="zoom:50%;" />

这种设计带来以下的优点：

* 利用多核系统的并发处理能力
* 负载均衡
* master进程会负责监控工作进程的状态，并负责管理其行为



## 2.5 平台无关的代码实现

在 使 用 C 语 言 实 现 Nginx 时， 尽 量 减 少 使 用 与 操 作 系 统 平 台 相 关 的 代 码， 如 某 个 操 作 系 统 上 的 第 三 方 库。 Nginx 重 新 封 装 了 日 志、 各 种 基 本 数 据 结 构（ 如 第 7 章 中 介 绍 的 容 器）、 常 用 算 法 等 工 具 软 件， 在 核 心 代 码 都 使 用 了 与 操 作 系 统 无 关 的 代 码 实 现，



## 2.6 内存池设计

nginx为每一个tcp连接都分配了一个内存池。把多次向系统申请内存的操作整合成一次，这大大的减少了cpu资源的消耗，同时减少了内存碎片



## 2.7 使用同一管道过滤器模式的http过滤模块

有 一 类 HTTP 模 块 被 命 名 为 HTTP 过 滤 模 块， 其 中 每 一 个 过 滤 模 块 都 有 输 入 端 和 输 出 端， 这 些 输 入 端 和 输 出 端 都 具 有 统 一 的 接 口。 这 些 过 滤 模 块 将 按 照 configure 执 行 时 决 定 的 顺 序 组 成 一 个 流 水 线 式 的 加 工 HTTP 响 应 的 中 心， 每 一 个 过 滤 模 块 都 是 完 全 独 立 的，它 处 理 着 输 入 端 接 收 到 的 数 据， 并 由 输 出 端 传 递 给 下 一 个 过 滤 模 块。 每 一 个 过 滤 模 块 都 必 须 可 以 增 量 地 处 理 数 据， 也 就 是 说 能 够 正 确 处 理 完 整 数 据 流 的 一 部 分。

这 种 统 一 管 理 过 滤 器 的 设 计 方 式 的 好 处 非 常 明 显： 首 先 它 允 许 把 整 个 HTTP 过 滤 系 统 的 输 入/ 输 出 简 化 为 一 个 个 过 滤 模 块 的 简 单 组 合， 这 大 大 提 高 了 简 单 性； 其 次， 它 提 供 了 很 好 的 可 重 用 性， 任 意 两 个 HTTP 过 滤 模 块 都 可 以 连 接 在 一 起（ 在 可 允 许 的 范 围 内）； 再 次， 整 个 过 滤 系 统 非 常 容 易 维 护、 增 强。 例 如， 开 发 了 一 个 新 的 过 滤 模 块 后， 可 以 非 常 方 便 地 添 加 到 过 滤 系 统 中， 这 是 一 种 高 可 扩 展 性。 又 如， 旧 的 过 滤 模 块 可 以 很 容 易 地 被 升 级 版 的 过 滤 模 块 所 替 代， 这 是 一 种 高 可 进 化 性； 接 着， 它 在 可 验 证 性 和 可 测 试 性 上 非 常 友 好， 我 们 可 以 灵 活 地 变 动 这 个 过 滤 模 块 流 水 线 来 验 证 功 能； 最 后， 这 样 的 系 统 完 全 支 持 并 发 执 行。



# 3.Nginx结构体

## 3.1 ngx_listening_t

略

## 3.2 ngx_cycle_t

略



# 4.Nginx启动时框架处理流程

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20210303164305992.png" alt="image-20210303164305992" style="zoom: 80%;" />

