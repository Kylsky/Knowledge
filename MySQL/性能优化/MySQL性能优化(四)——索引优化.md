# MySQL性能优化(四)——索引优化



## 一、索引分类

### 主键索引

主键是一种唯一性索引，但它必须指定为Primary Key,每个表只能有一个主键

### 唯一索引

索引列的所有值都只能出现一次，即必须唯一，值可以为空

### 普通索引

基本索引类型，值可以为空，没有唯一性限制(**覆盖索引**，可以避免回表)

### 全文索引

MyISAM支持，InnoDB在5.6以后支持。全文索引可以在varchar、chai、text上创建

### 组合索引

多列值组成一个索引，专门用于组合索引(**最左前缀原则**)



## 二、索引存储结构

### 1.hash表

hash表在每次添加索引时计算指定列的hash值，取模运算后计算出下表，将元素插入下标位置

**优点**：适合等值查询

**缺点**：表中数据是无序的，不适合范围查询，需要挨个进行遍历操作。另外在使用过程中需要将hash表全表加载到内存，会存在空间浪费



### 2.二叉树

二叉树的最快时间复杂度为O(logN)，但是可能由于数据的原因导致树的深度太深，影响查找



### 3.B树

1.所有键值对分布在整棵树中

2.搜索可能在非叶子节点结束，在关键字全集内做一次查找，性能逼近二分查找

3.每个节点最多拥有m个子树

4.根节点至少有2个子树

5.分支节点至少拥有m/2颗子树

6.所有叶子节点都在同一层，每个节点最多可以有m-1个key，并且以升序排列

**缺点**：每一个节点存放的数据有限，会导致每个节点存储的key数量变小，进而导致数的深度较大，增大查询时磁盘IO次数，进而影响性能

![img](http://kylescloud.top/site/pic/B+Tree.png)



### 4.B+树

在B数的基础上进行了改进，非叶子节点不再存储data，使用叶子节点存储data 

**InnoDB存储结构**

![img](http://kylescloud.top/site/pic/B+Tree1.jpg)

InnoDB通过B+树结构对主键创建索引，然后叶子节点中存储记录，如果没有主键，那么会选择唯一键，如果没有唯一键，则会生成一个6位的row_id来作为主键。

如果创建索引的键是其他字段，那么在根据该字段创建的B+树上叶子节点中存储的是该记录的主键，然后再通过主键索引找到对应的记录，这被称为**回表**



**MyISAM存储结构**

![img](http://kylescloud.top/site/pic/MyISAMB+Tree.jpg)



## 三、MySQL存储模型

![img](http://kylescloud.top/site/pic/MySQLModel2.jpg)

不同的存储引擎中，数据文件和索引文件存放的位置是不同的，因此有了分类

### 聚簇索引

InnoDB中，数据文件和索引文件存放在一起，后缀为.frm的文件存放的是表结构，后缀为.ibd存放了数据文件和索引文件，需要注意的是，MySQL的InnoDB存储引擎默认情况下会把所有的数据文件放到表空间中，不会为每一个单独的表保存一份数据文件，如果需要将每一个表单独使用文件保存，设置如下属性：set global innodb_file_per_table=on;



### 非聚簇索引

MyISAM中，数据和索引单独存放一个文件。后缀为.frm的文件存放表结构，后缀为.MYI的文件存放索引，后缀为.MYD的文件存放数据



## 四、索引下推

联合索引在回表操作之前做筛选，之后再回表查询全行数据，提高了执行的效率

参考：https://blog.csdn.net/mccand1234/article/details/95799942

### 

## 五、索引维护

索引在插入新的值的时候，为了维护索引的有序性，必须要维护，在维护索引的时候需要分以下几种情况：

1.如果插入一个比较大的值，直接插入即可，几乎没有成本

2.如果插入的是中间的某一个值，需要逻辑上移动后续的元素，空出位置

3.如果需要插入的数据页满了，就需要单独申请一个新的数据页，然后移动部分数据过去(页分裂)，此时性能会受影响同时空间的使用率也会降低

因此尽量使用自增主键作为索引



## 六、存储引擎

![img](http://kylescloud.top/site/pic/MySQLEgine.jpg)