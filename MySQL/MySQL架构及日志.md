# MySQL架构及日志

## 一、MySQL基本架构图

![img](http://kylescloud.top/site/pic/MySQLArchi.jpg)



### 连接器

负责和客户端建立连接，获取权限、维持和管理连接，主要负责以下任务：

1.用户名密码验证

2.查询权限信息，分配对应的权限

可以使用show processlist查看当前的连接，若连接太长时间没有相应，就会自动断开，可以通过wait_timeout控制，默认为8小时。另外，连接分为长连接和短连接，推荐使用长连接，但是需要周期性地断开长连接，防止资源浪费



### 查询缓存

顾名思义，之前执行过的sql语句和结果可能会以key-value形式存储在缓存中，但是不推荐使用查询缓存，因为查询缓存失效较为频繁，只要表更新，缓存就会清空，且缓存对应新更新的数据命中率比较低



### 分析器

**词法分析**：把输入的字符串进行识别，解释每个部分代表什么意思

**语法分析**：根据语法规则判断sql语句是否满足mysql语法，若不符合则报错"you have an syntax error in......"



### 优化器

在具体执行sql语句之前，要先经过优化器的处理——当表中有多个索引，决定使用哪个索引；当sql语句需要做多表关联时，决定表连接的顺序。优化器主要有两个规则：RBO(基于规则的优化)、CBO(基于成本的优化)



## 二、MySQL日志

###  Redo日志

InnoDB存储引擎的日志文件。当数据发生修改的时候，InnoDB会先将记录写道redolog中，并更新内存，此时更新就算是完成了，同时InnoDB会在合适的时机将记录操作到磁盘中。



### Undo日志

为了实现事务的原子性，在操作任何数据之前，首先将数据备份到Undolog中，然后进行数据修改，如果出现了错误或者用户使用了rollback，系统可以利用undolog中的备份将数据恢复到事务开始之前的状态。undolog使用逻辑操作记录数据备份，如：

1.当delete一条记录时，undo log中会记录一条对应的insert记录

2.当insert一条记录时，undo log会记录一条对应的delete记录

3.当update一条记录时，它记录一条对应相反的update记录



### *Binlog——服务端的日志文件

binlog是server层的日志，主要做mysql功能层面的功能，记录了每个语句的原始逻辑(记录sql或者记录行)，通过set log_bin on;开启该功能。binlog与redolog的区别在于：

1.redo是innodb独有的，binlog是mysql server端有所有引擎都支持的

2.redo是物理日志，记录的是在某个数据页上做了什么修改，binlog是逻辑日志，记录的是语句的原始逻辑

3.redo是循环写的，binlog是可以追加写的，不会覆盖之前的内容