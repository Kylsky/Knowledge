ps:笔记基于《深入理解java虚拟机》，关于hotspot以下的算法实现细节，尝试利用逻辑将其关系串联起来，帮助更好的理解：

jvm使用可达性算法（根节点枚举算法）进行gc时，首先需要获取到所有根节点，这里出现了**OopMap**化解了遍历整个虚拟机内存中的出现的性能问题， OopMap在类 加 载 动 作 完 成时就会生成 。同时，考虑到oopmap的维护成本和计算成本，其应该只存放特定代码位置的相关root gc，这些特定的位置就被称为**安全点**。搜索根节点需要暂停所有线程来获取root gc，由于在线程执行时随时可能会发生引用关系的变化，因此为了保证一致性，线程必须要在安全点才能暂停。

hotspot通过内存陷阱的方式实现线程的主动终断，即设置标志位，令线程轮询检测是否为true，若为true，则到下一个安全点挂起。关于安全区域梳理介绍不多，考虑也是使用这种方式。

为 解 决 对 象 跨 代 引 用 所 带 来 的 问 题， 垃 圾 收 集 器 在 新 生 代 中 建 立 了 名 为 记 忆 集（ Remembered Set） 的 数 据 结 构， 用 以 避 免 把 整 个 老 年 代 加 进 GC Roots 扫 描 范 围。



## 1.根节点枚举算法

在看根节点枚举算法之前，认为需要先回顾一下哪些被jvm判定为根节点，即GC Roots：

1. 在 虚 拟 机 栈（ 栈 帧 中 的 本 地 变 量 表） 中 引 用 的 对 象， 譬 如 各 个 线 程 被 调 用 的 方 法 堆 栈 中 使 用 到 的 参 数、 局 部 变 量、 临 时 变 量 等。

2. 在 方 法 区 中 类 静 态 属 性 引 用 的 对 象， 譬 如 Java 类 的 引 用 类 型 静 态 变 量。
3. ·在 方 法 区 中 常 量 引 用 的 对 象， 譬 如 字 符 串 常 量 池（ String Table） 里 的 引 用
4. ·在 本 地 方 法 栈 中 JNI（ 即 通 常 所 说 的 Native 方 法） 引 用 的 对 象。
5. Java 虚 拟 机 内 部 的 引 用， 如 基 本 数 据 类 型 对 应 的 Class 对 象， 一 些 常 驻 的 异 常 对 象（ 比 如 NullPointExcepiton、 OutOfMemoryError） 等， 还 有 系 统 类 加 载 器。
6. 所 有 被 同 步 锁（ synchronized 关 键 字） 持 有 的 对 象。
7. 反 映 Java 虚 拟 机 内 部 情 况 的 JMXBean、 JVMTI 中 注 册 的 回 调、 本 地 代 码 缓 存 等。



### Stop the World

迄 今 为 止， 所 有 收 集 器 在 根 节 点 枚 举 这 一 步 骤 时 都 是 必 须 暂 停 用 户 线 程 的根 节 点 枚 举 必 须 在 一 个 能 保 障 一 致 性 的 快 照 中 才 得 以 进 行—— 这 里“ 一 致 性” 的 意 思 是 整 个 枚 举 期 间 执 行 子 系 统 看 起 来 就 像 被 冻 结 在 某 个 时 间 点 上， 不 会 出 现 分 析 过 程 中， 根 节 点 集 合 的 对 象 引 用 关 系 还 在 不 断 变 化 的 情 况， 若 这 点 不 能 满 足 的 话， 分 析 结 果 准 确 性 也 就 无 法 保 证。 这 是 导 致 垃 圾 收 集 过 程 必 须 停 顿 所 有 用 户 线 程 的 其 中 一 个 重 要 原 因， 即 使 是 号 称 停 顿 时 间 可 控， 或 者（ 几 乎） 不 会 发 生 停 顿 的 CMS、 G1、 ZGC 等 收 集 器， 枚 举 根 节 点 时 也 是 必 须 要 停 顿 的。



### OopMap

由 于 目 前 主 流 Java 虚 拟 机 使 用 的 都 是 准 确 式 垃 圾 收 集（即jvm可以判断内存区域存储的是对象还是对象的引用）， 所 以 当 用 户 线 程 停 顿 下 来 之 后， 其 实 并 不 需 要 一 个 不 漏 地 检 查 完 所 有 执 行 上 下 文 和 全 局 的 引 用 位 置， 虚 拟 机 应 当 是 有 办 法 直 接 得 到 哪 些 地 方 存 放 着 对 象 引 用 的。 在 HotSpot 的 解 决 方 案 里， 是 使 用 一 组 称 为 OopMap 的 数 据 结 构 来 达 到 这 个 目 的。 一 旦 类 加 载 动 作 完 成 的 时 候， HotSpot 就 会 把 对 象 内 什 么 偏 移 量 上 是 什 么 类 型 的 数 据 计 算 出 来， 在 即 时 编 译 过 程 中， 也 会 在 特 定 的 位 置 记 录 下 栈 里 和 寄 存 器 里 哪 些 位 置 是 引 用。 这 样 收 集 器 在 扫 描 时 就 可 以 直 接 得 知 这 些 信 息 了， 并 不 需 要 真 正 一 个 不 漏 地 从 方 法 区 等 GC Roots 开 始 查 找。



## 2.安全点

众所周知，引用关系变化是十分常见的，引用之间变化就会影响到OopMap的变化， 如 果 为 每 一 条 指 令 都 生 成 对 应 的 OopMap， 那 将 会 需 要 大 量 的 额 外 存 储 空 间， 这 样 垃 圾 收 集 伴 随 的 空 间 成 本 就 会 非 常 大。实 际 上 HotSpot 也 的 确 没 有 为 每 条 指 令 都 生 成 OopMap， 前 面 已 经 提 到， 只 是 在“ 特 定 的 位 置” 记 录 了 这 些 信 息， 这 些 位 置 被 称 为 安 全 点（ Safepoint）。

安 全 点 位 置 的 选 取 基 本 上 是 以“ 是 否 具 有 让 程 序 长 时 间 执 行 的 特 征” 为 标 准 进 行 选 定 ， 例 如 方 法 调 用、 循 环 跳 转、 异 常 跳 转 等 都 属 于 指 令 序 列 复 用， 所 以 只 有 具 有 这 些 功 能 的 指 令 才 会 产 生 安 全 点。 (Kindle 位置 2176-2179)

对 于 安 全 点， 另 外 一 个 需 要 考 虑 的 问 题 是， 如 何 在 垃 圾 收 集 发 生 时 让 所 有 线 程（ 不 包 括 执 行 JNI 调 用 的 线 程） 都 跑 到 最 近 的 安 全 点， 然 后 停 顿 下 来。 这 里 有 两 种 方 案 可 供 选 择： **抢 先 式 中 断**（ Preemptive Suspension） 和 **主 动 式 中 断**（ Voluntary Suspension）。

抢 先 式 中 断 不 需 要 线 程 的 执 行 代 码 主 动 去 配 合， 在 垃 圾 收 集 发 生 时， 系 统 首 先 把 所 有 用 户 线 程 全 部 中 断， 如 果 发 现 有 用 户 线 程 中 断 的 地 方 不 在 安 全 点 上， 就 恢 复 这 条 线 程 执 行， 让 它 一 会 再 重 新 中 断， 直 到 跑 到 安 全 点 上。 现 在 几 乎 没 有 虚 拟 机 实 现 采 用 抢 先 式 中 断 来 暂 停 线 程 响 应 GC 事 件。

主 动 式 中 断 的 思 想 是 当 垃 圾 收 集 需 要 中 断 线 程 的 时 候， 不 直 接 对 线 程 操 作， 仅 仅 简 单 地 设 置 一 个 标 志 位， 各 个 线 程 执 行 过 程 时 会 不 停 地 主 动 去 轮 询 这 个 标 志， 一 旦 发 现 中 断 标 志 为 真 时 就 自 己 在 最 近 的 安 全 点 上 主 动 中 断 挂 起。 轮 询 标 志 的 地 方 和 安 全 点 是 重 合 的， 另 外 还 要 加 上 所 有 创 建 对 象 和 其 他 需 要 在 Java 堆 上 分 配 内 存 的 地 方， 这 是 为 了 检 查 是 否 即 将 要 发 生 垃 圾 收 集， 避 免 没 有 足 够 内 存 分 配 新 对 象。

由 于 轮 询 操 作 在 代 码 中 会 频 繁 出 现， 这 要 求 它 必 须 足 够 高 效。 HotSpot 使 用 **内 存 保 护 陷 阱** 的 方 式， 把 轮 询 操 作 精 简 至 只 有 一 条 汇 编 指 令 的 程 度。 下 面 代 码 清 单 3-4 中 的 test 指 令 就 是 HotSpot 生 成 的 轮 询 指 令， 当 需 要 暂 停 用 户 线 程 时， 虚 拟 机 把 0x160100 的 内 存 页 设 置 为 不 可 读， 那 线 程 执 行 到 test 指 令 时 就 会 产 生 一 个 自 陷 异 常 信 号， 然 后 在 预 先 注 册 的 异 常 处 理 器 中 挂 起 线 程 实 现 等 待， 这 样 仅 通 过 一 条 汇 编 指 令 便 完 成 安 全 点 轮 询 和 触 发 线 程 中 断 了。



## 3.安全区域

使 用 安 全 点 的 设 计 似 乎 已 经 完 美 解 决 如 何 停 顿 用 户 线 程， 让 虚 拟 机 进 入 垃 圾 回 收 状 态 的 问 题 了， 但 实 际 情 况 却 并 不 一 定。 安 全 点 机 制 保 证 了 程 序 执 行 时， 在 不 太 长 的 时 间 内 就 会 遇 到 可 进 入 垃 圾 收 集 过 程 的 安 全 点。 

但 是， 程 序“ 不 执 行” 的 时 候 呢？ 所 谓 的 程 序 不 执 行 就 是 没 有 分 配 处 理 器 时 间， 典 型 的 场 景 便 是 用 户 线 程 处 于 Sleep 状 态 或 者 Blocked 状 态， 这 时 候 线 程 无 法 响 应 虚 拟 机 的 中 断 请 求， 不 能 再 走 到 安 全 的 地 方 去 中 断 挂 起 自 己， 虚 拟 机 也 显 然 不 可 能 持 续 等 待 线 程 重 新 被 激 活 分 配 处 理 器 时 间。 对 于 这 种 情 况， 就 必 须 引 入 安 全 区 域（ Safe Region） 来 解 决。 

**安 全 区 域** 是 指 能 够 确 保 在 某 一 段 代 码 片 段 之 中， 引 用 关 系 不 会 发 生 变 化， 因 此， 在 这 个 区 域 中 任 意 地 方 开 始 垃 圾 收 集 都 是 安 全 的。 我 们 也 可 以 把 安 全 区 域 看 作 被 扩 展 拉 伸 了 的 安 全 点。 

当 用 户 线 程 执 行 到 安 全 区 域 里 面 的 代 码 时， 首 先 会 标 识 自 己 已 经 进 入 了 安 全 区 域， 那 样 当 这 段 时 间 里 虚 拟 机 要 发 起 垃 圾 收 集 时 就 不 必 去 管 这 些 已 声 明 自 己 在 安 全 区 域 内 的 线 程 了。 

当 线 程 要 离 开 安 全 区 域 时， 它 要 检 查 虚 拟 机 是 否 已 经 完 成 了 根 节 点 枚 举（ 或 者 垃 圾 收 集 过 程 中 其 他 需 要 暂 停 用 户 线 程 的 阶 段）， 如 果 完 成 了， 那 线 程 就 当 作 没 事 发 生 过， 继 续 执 行； 否 则 它 就 必 须 一 直 等 待， 直 到 收 到 可 以 离 开 安 全 区 域 的 信 号 为 止。



## 4.记忆集及卡表

为 解 决 对 象 跨 代 引 用 所 带 来 的 问 题， 垃 圾 收 集 器 在 新 生 代 中 建 立 了 名 为 记 忆 集（ Remembered Set） 的 数 据 结 构， 用 以 避 免 把 整 个 老 年 代 加 进 GC Roots 扫 描 范 围。 事 实 上 并 不 只 是 新 生 代、 老 年 代 之 间 才 有 跨 代 引 用 的 问 题， 所 有 涉 及 部 分 区 域 收 集（ Partial GC） 行 为 的 垃 圾 收 集 器， 典 型 的 如 G1、 ZGC 和 Shenandoah 收 集 器， 都 会 面 临 相 同 的 问 题。

记 忆 集 是 一 种 用 于 记 录 从 非 收 集 区 域 指 向 收 集 区 域 的 指 针 集 合 的 抽 象 数 据 结 构。 如 果 我 们 不 考 虑 效 率 和 成 本 的 话， 最 简 单 的 实 现 可 以 用 非 收 集 区 域 中 所 有 含 跨 代 引 用 的 对 象 数 组 来 实 现 这 个 数 据 结 构。

在 垃 圾 收 集 的 场 景 中， 收 集 器 只 需 要 通 过 记 忆 集 判 断 出 某 一 块 非 收 集 区 域 是 否 存 在 有 指 向 了 收 集 区 域 的 指 针 就 可 以 了， 并 不 需 要 了 解 这 些 跨 代 指 针 的 全 部 细 节。 那 设 计 者 在 实 现 记 忆 集 的 时 候， 便 可 以 选 择 更 为 粗 犷 的 记 录 粒 度 来 节 省 记 忆 集 的 存 储 和 维 护 成 本， 下 面 列 举 了 一 些 可 供 选 择（ 当 然 也 可 以 选 择 这 个 范 围 以 外 的） 的 记 录 精 度：

**字 长 精 度**： 每 个 记 录 精 确 到 一 个 机 器 字 长（ 就 是 处 理 器 的 寻 址 位 数， 如 常 见 的 32 位 或 64 位， 这 个 精 度 决 定 了 机 器 访 问 物 理 内 存 地 址 的 指 针 长 度）， 该 字 包 含 跨 代 指 针。

**对 象 精 度**： 每 个 记 录 精 确 到 一 个 对 象， 该 对 象 里 有 字 段 含 有 跨 代 指 针。

**卡 精 度**： 每 个 记 录 精 确 到 一 块 内 存 区 域， 该 区 域 内 有 对 象 含 有 跨 代 指 针。

其 中， 第 三 种“ 卡 精 度” 所 指 的 是 用 一 种 称 为“ 卡 表”（ Card Table） 的 方 式 去 实 现 记 忆 集 ，这 也 是 目 前 最 常 用 的 一 种 记 忆 集 实 现 形 式， 一 些 资 料 中 甚 至 直 接 把 它 和 记 忆 集 混 为 一 谈。 前 面 定 义 中 提 到 记 忆 集 其 实 是 一 种“ 抽 象” 的 数 据 结 构， 抽 象 的 意 思 是 只 定 义 了 记 忆 集 的 行 为 意 图， 并 没 有 定 义 其 行 为 的 具 体 实 现。 卡 表 就 是 记 忆 集 的 一 种 具 体 实 现， 它 定 义 了 记 忆 集 的 记 录 精 度、 与 堆 内 存 的 映 射 关 系 等。 关 于 卡 表 与 记 忆 集 的 关 系， 读 者 不 妨 按 照 Java 语 言 中 HashMap 与 Map 的 关 系 来 类 比 理 解。

![image-20201022164524801](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20201022164524801.png)

一 个 卡 页 的 内 存 中 通 常 包 含 不 止 一 个 对 象， 只 要 卡 页 内 有 一 个（ 或 更 多） 对 象 的 字 段 存 在 着 跨 代 指 针， 那 就 将 对 应 卡 表 的 数 组 元 素 的 值 标 识 为 1， 称 为 这 个 元 素 变 脏（ Dirty）， 没 有 则 标 识 为 0。 在 垃 圾 收 集 发 生 时， 只 要 筛 选 出 卡 表 中 变 脏 的 元 素， 就 能 轻 易 得 出 哪 些 卡 页 内 存 块 中 包 含 跨 代 指 针， 把 它 们 加 入 GC Roots 中 一 并 扫 描。



## 5.写屏障

上 面已 经 解 决 了 如 何 使 用 记 忆 集 来 缩 减 GC Roots 扫 描 范 围 的 问 题， 但 还 没 有 解 决 卡 表 元 素 如 何 维 护 的 问 题， 例 如 它 们 何 时 变 脏、 谁 来 把 它 们 变 脏 等。 

卡 表 元 素 何 时 变 脏 的 答 案 是 很 明 确 的—— 有 其 他 分 代 区 域 中 对 象 引 用 了 本 区 域 对 象 时， 其 对 应 的 卡 表 元 素 就 应 该 变 脏， 变 脏 时 间 点 原 则 上 应 该 发 生 在 引 用 类 型 字 段 赋 值 的 那 一 刻。 

但 问 题 是 如 何 变 脏， 即 如 何 在 对 象 赋 值 的 那 一 刻 去 更 新 维 护 卡 表 呢？ 假 如 是 解 释 执 行 的 字 节 码， 那 相 对 好 处 理， 虚 拟 机 负 责 每 条 字 节 码 指 令 的 执 行， 有 充 分 的 介 入 空 间； 但 在 编 译 执 行 的 场 景 中 呢？ 经 过 即 时 编 译 后 的 代 码 已 经 是 纯 粹 的 机 器 指 令 流 了， 这 就 必 须 找 到 一 个 在 机 器 码 层 面 的 手 段， 把 维 护 卡 表 的 动 作 放 到 每 一 个 赋 值 操 作 之 中。 

在 HotSpot 虚 拟 机 里 是 通 过 **写 屏 障**（ Write Barrier） 技 术 维 护 卡 表 状 态 的。 先 请 读 者 注 意 将 这 里 提 到 的“ 写 屏 障”， 以 及 后 面 在 低 延 迟 收 集 器 中 会 提 到 的“ 读 屏 障” 与 解 决 并 发 乱 序 执 行 问 题 中 的“ 内 存 屏 障”  区 分 开 来， 避 免 混 淆。 写 屏 障 可 以 看 作 在 虚 拟 机 层 面 对“ 引 用 类 型 字 段 赋 值” 这 个 动 作 的 AOP 切 面 ，在 引 用 对 象 赋 值 时 会 **产 生 一 个 环 形（ Around） 通 知**， 供 程 序 执 行 额 外 的 动 作， 也 就 是 说 赋 值 的 前 后 都 在 写 屏 障 的 覆 盖 范 畴 内。 

在 赋 值 前 的 部 分 的 写 屏 障 叫 作 写 前 屏 障（ Pre-Write Barrier）， 在 赋 值 后 的 则 叫 作 写 后 屏 障（ Post-Write Barrier）。 HotSpot 虚 拟 机 的 许 多 收 集 器 中 都 有 使 用 到 写 屏 障， 但 直 至 G1 收 集 器 出 现 之 前， 其 他 收 集 器 都 只 用 到 了 写 后 屏 障。

除 了 写 屏 障 的 开 销 外， 卡 表 在 高 并 发 场 景 下 还 面 临 着“ 伪 共 享”（ False Sharing） 问 题。 伪 共 享 是 处 理 并 发 底 层 细 节 时 一 种 经 常 需 要 考 虑 的 问 题， 现 代 中 央 处 理 器 的 缓 存 系 统 中 是 以 缓 存 行（ Cache Line） 为 单 位 存 储 的， 当 多 线 程 修 改 互 相 独 立 的 变 量 时， 如 果 这 些 变 量 恰 好 共 享 同 一 个 缓 存 行， 就 会 彼 此 影 响（ 写 回、 无 效 化 或 者 同 步） 而 导 致 性 能 降 低， 这 就 是 伪 共 享 问 题。 

假 设 处 理 器 的 缓 存 行 大 小 为 64 字 节， 由 于 一 个 卡 表 元 素 占 1 个 字 节， 64 个 卡 表 元 素 将 共 享 同 一 个 缓 存 行。 这 64 个 卡 表 元 素 对 应 的 卡 页 总 的 内 存 为 32KB（ 64 × 512 字 节）， 也 就 是 说 如 果 不 同 线 程 更 新 的 对 象 正 好 处 于 这 32KB 的 内 存 区 域 内， 就 会 导 致 更 新 卡 表 时 正 好 写 入 同 一 个 缓 存 行 而 影 响 性 能。 为 了 避 免 伪 共 享 问 题， 一 种 简 单 的 解 决 方 案 是 不 采 用 无 条 件 的 写 屏 障， 而 是 先 检 查 卡 表 标 记， 只 有 当 该 卡 表 元 素 未 被 标 记 过 时 才 将 其 标 记 为 变 脏。



## 6.并发可达性分析

想 解 决 或 者 降 低 用 户 线 程 的 停 顿， 就 必 须 在 一 个 能 保 障 一 致 性 的 快 照 上 才 能 进 行 对 象 图 的 遍 历。关于为什么需要一个保障一致性的快照，这里使用三色标记来辅助推导：

**白 色**： 表 示 对 象 尚 未 被 垃 圾 收 集 器 访 问 过。 显 然 在 可 达 性 分 析 刚 刚 开 始 的 阶 段， 所 有 的 对 象 都 是 白 色 的， 若 在 分 析 结 束 的 阶 段， 仍 然 是 白 色 的 对 象， 即 代 表 不 可 达。 

**黑 色**： 表 示 对 象 已 经 被 垃 圾 收 集 器 访 问 过， 且 这 个 对 象 的 所 有 引 用 都 已 经 扫 描 过。 黑 色 的 对 象 代 表 已 经 扫 描 过， 它 是 安 全 存 活 的， 如 果 有 其 他 对 象 引 用 指 向 了 黑 色 对 象， 无 须 重 新 扫 描 一 遍。 黑 色 对 象 不 可 能 直 接（ 不 经 过 灰 色 对 象） 指 向 某 个 白 色 对 象。

**灰 色**： 表 示 对 象 已 经 被 垃 圾 收 集 器 访 问 过， 但 这 个 对 象 上 至 少 存 在 一 个 引 用 还 没 有 被 扫 描 过。

关 于 可 达 性 分 析 的 扫 描 过 程， 读 者 不 妨 发 挥 一 下 想 象 力， 把 它 看 作 对 象 图 上 一 股 以 灰 色 为 波 峰 的 波 纹 从 黑 向 白 推 进 的 过 程， 如 果 用 户 线 程 此 时 是 冻 结 的， 只 有 收 集 器 线 程 在 工 作， 那 不 会 有 任 何 问 题。 但 如 果 用 户 线 程 与 收 集 器 是 并 发 工 作 呢？ 收 集 器 在 对 象 图 上 标 记 颜 色， 同 时 用 户 线 程 在 修 改 引 用 关 系—— 即 修 改 对 象 图 的 结 构， 这 样 可 能 出 现 两 种 后 果。 一 种 是 把 原 本 消 亡 的 对 象 错 误 标 记 为 存 活， 这 不 是 好 事， 但 其 实 是 可 以 容 忍 的， 只 不 过 产 生 了 一 点 逃 过 本 次 收 集 的 浮 动 垃 圾 而 已， 下 次 收 集 清 理 掉 就 好。 另 一 种 是 把 原 本 存 活 的 对 象 错 误 标 记 为 已 消 亡， 这 就 是 非 常 致 命 的 后 果 了， 程 序 肯 定 会 因 此 发 生 错 误， 下 面 表 3-1 演 示 了 这 样 的 致 命 错 误 具 体 是 如 何 产 生 的。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20201022171942240.png" alt="image-20201022171942240" style="zoom:67%;" />



Wilson 于 1994 年 在 理 论 上 证 明 了， 当 且 仅 当 以 下 两 个 条 件 同 时 满 足 时， 会 产 生“ 对 象 消 失” 的 问 题， 即 原 本 应 该 是 黑 色 的 对 象 被 误 标 为 白 色： 

1.赋 值 器 插 入 了 一 条 或 多 条 从 黑 色 对 象 到 白 色 对 象 的 新 引 用； 

2.赋 值 器 删 除 了 全 部 从 灰 色 对 象 到 该 白 色 对 象 的 直 接 或 间 接 引 用。

因 此， 我 们 要 解 决 并 发 扫 描 时 的 对 象 消 失 问 题， 只 需 破 坏 这 两 个 条 件 的 任 意 一 个 即 可。 由 此 分 别 产 生 了 两 种 解 决 方 案： 增 量 更 新（ Incremental Update） 和 原 始 快 照（ Snapshot At The Beginning， SATB）。

**增 量 更 新** 要 破 坏 的 是 第 一 个 条 件， 当 黑 色 对 象 插 入 新 的 指 向 白 色 对 象 的 引 用 关 系 时， 就 将 这 个 新 插 入 的 引 用 记 录 下 来， 等 并 发 扫 描 结 束 之 后， 再 将 这 些 记 录 过 的 引 用 关 系 中 的 黑 色 对 象 为 根， 重 新 扫 描 一 次。 这 可 以 简 化 理 解 为， 黑 色 对 象 一 旦 新 插 入 了 指 向 白 色 对 象 的 引 用 之 后， 它 就 变 回 灰 色 对 象 了。 

**原 始 快 照** 要 破 坏 的 是 第 二 个 条 件， 当 灰 色 对 象 要 删 除 指 向 白 色 对 象 的 引 用 关 系 时， 就 将 这 个 要 删 除 的 引 用 记 录 下 来， 在 并 发 扫 描 结 束 之 后， 再 将 这 些 记 录 过 的 引 用 关 系 中 的 灰 色 对 象 为 根， 重 新 扫 描 一 次。 这 也 可 以 简 化 理 解 为， 无 论 引 用 关 系 删 除 与 否， 都 会 按 照 刚 刚 开 始 扫 描 那 一 刻 的 对 象 图 快 照 来 进 行 搜 索。 以 上 无 论 是 对 引 用 关 系 记 录 的 插 入 还 是 删 除， 虚 拟 机 的 记 录 操 作 都 是 通 过 写 屏 障 实 现 的。 

在 HotSpot 虚 拟 机 中， 增 量 更 新 和 原 始 快 照 这 两 种 解 决 方 案 都 有 实 际 应 用， 譬 如， CMS 是 基 于 增 量 更 新 来 做 并 发 标 记 的， G1、 Shenandoah 则 是 用 原 始 快 照 来 实 现。