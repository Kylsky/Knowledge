## 1.对象优先在Eden分配

大 多 数 情 况 下， 对 象 优 先 在 新 生 代 Eden 区 中 分 配。 当 Eden 区 没 有 足 够 空 间 进 行 分 配 时， 虚 拟 机 将 发 起 第 一 次 Minor GC，随后将eden中无法清理的对象存入suvivor from。随后的每一次GC，eden和suvivor from的存活对象都会到suvivor to，同时suvivor to和suvivor from交换定义。(其实就是每一次GC存活对象都会被放到空的suvivor中)

```
可以通过-XX:PrintGCDetails参数查看内存回收日志
```



## 2.大对象直接进入老年代

大 对 象 就 是 指 需 要 大 量 连 续 内 存 空 间 的 Java 对 象， 最 典 型 的 大 对 象 便 是 那 种 很 长 的 字 符 串， 或 者 元 素 数 量 很 庞 大 的 数 组，在 Java 虚 拟 机 中 要 避 免 大 对 象 的 原 因 是， 在 分 配 空 间 时， 它 容 易 导 致 内 存 明 明 还 有 不 少 空 间 时 就 提 前 触 发 垃 圾 收 集， 以 获 取 足 够 的 连 续 空 间 才 能 安 置 好 它 们， 而 当 复 制 对 象 时， 大 对 象 就 意 味 着 高 额 的 内 存 复 制 开 销。 HotSpot 虚 拟 机 提 供 了**-XX:PretenureSizeThreshold** 参 数， 指 定 大 于 该 设 置 值 的 对 象 直 接 在 老 年 代 分 配， 这 样 做 的 目 的 就 是 避 免 在 Eden 区 及 两 个 Survivor 区 之 间 来 回 复 制， 产 生 大 量 的 内 存 复 制 操 作。



## 3.长期存活对象进入老年代

HotSpot 虚 拟 机 中 多 数 收 集 器 都 采 用 了 分 代 收 集 来 管 理 堆 内 存， 那 内 存 回 收 时 就 必 须 能 决 策 哪 些 存 活 对 象 应 当 放 在 新 生 代， 哪 些 存 活 对 象 放 在 老 年 代 中。 为 做 到 这 点， 虚 拟 机 给 每 个 对 象 定 义 了 一 个 对 象 年 龄（ Age） 计 数 器， 存 储 在 对 象 头 中。 对 象 通 常 在 Eden 区 里 诞 生， 如 果 经 过 第 一 次 Minor GC 后 仍 然 存 活， 并 且 能 被 Survivor 容 纳 的 话， 该 对 象 会 被 移 动 到 Survivor 空 间 中， 并 且 将 其 对 象 年 龄 设 为 1 岁。 对 象 在 Survivor 区 中 每 熬 过 一 次 Minor GC， 年 龄 就 增 加 1 岁， 当 它 的 年 龄 增 加 到 一 定 程 度（ 默 认 为 15）， 就 会 被 晋 升 到 老 年 代 中。 对 象 晋 升 老 年 代 的 年 龄 阈 值， 可 以 通 过 参 数**-XX:MaxTenuringThreshold** 设 置。



## 4.动态对象年龄判断

为 了 能 更 好 地 适 应 不 同 程 序 的 内 存 状 况， HotSpot 虚 拟 机 并 不 是 永 远 要 求 对 象 的 年 龄 必 须 达 到-XX：MaxTenuringThreshold 才 能 晋 升 老 年 代， 如 果 在 Survivor 空 间 中 相 同 年 龄 所 有 对 象 大 小 的 总 和 大 于 Survivor 空 间 的 一 半， 年 龄 大 于 或 等 于 该 年 龄 的 对 象 就 可 以 直 接 进 入 老 年 代， 无 须 等 到**-XX:MaxTenuringThreshold** 中 要 求 的 年 龄。



## 5.空间分配担保

在 发 生 Minor GC 之 前， 虚 拟 机 必 须 **先 检 查** 老 年 代 最 大 可 用 的 连 续 空 间 是 否 大 于 新 生 代 所 有 对 象 总 空 间， 如 果 这 个 条 件 成 立， 那 这 一 次 Minor GC 可 以 确 保 是 安 全 的。 如 果 不 成 立， 则 虚 拟 机 会 **先 查 看**-XX：HandlePromotionFailure 参 数 的 设 置 值 是 否 允 许 担 保 失 败（ Handle Promotion Failure）； 如 果 允 许， 那 会 **继 续 检 查** 老 年 代 最 大 可 用 的 连 续 空 间 是 否 大 于 历 次 晋 升 到 老 年 代 对 象 的 平 均 大 小， 如 果 大 于， 将 尝 试 进 行 一 次 Minor GC， 尽 管 这 次 Minor GC 是 有 风 险 的； 如 果 小 于， 或 者-XX：HandlePromotionFailure 设 置 不 允 许 冒 险， 那 这 时 就 要 改 为 进 行 一 次 Full GC。

解 释 一 下“ 冒 险” 是 冒 了 什 么 风 险： 前 面 提 到 过， 新 生 代 使 用 复 制 收 集 算 法， 但 为 了 内 存 利 用 率， 只 使 用 其 中 一 个 Survivor 空 间 来 作 为 轮 换 备 份， 因 此 当 出 现 大 量 对 象 在 Minor GC 后 仍 然 存 活 的 情 况—— 最 极 端 的 情 况 就 是 内 存 回 收 后 新 生 代 中 所 有 对 象 都 存 活， 需 要 老 年 代 进 行 分 配 担 保， 把 Survivor 无 法 容 纳 的 对 象 直 接 送 入 老 年 代， 这 与 生 活 中 贷 款 担 保 类 似。 老 年 代 要 进 行 这 样 的 担 保， 前 提 是 老 年 代 本 身 还 有 容 纳 这 些 对 象 的 剩 余 空 间， 但 一 共 有 多 少 对 象 会 在 这 次 回 收 中 活 下 来 在 实 际 完 成 内 存 回 收 之 前 是 无 法 明 确 知 道 的， 所 以 只 能 取 之 前 每 一 次 回 收 晋 升 到 老 年 代 对 象 容 量 的 平 均 大 小 作 为 经 验 值， 与 老 年 代 的 剩 余 空 间 进 行 比 较， 决 定 是 否 进 行 Full GC 来 让 老 年 代 腾 出 更 多 空 间。

取 历 史 平 均 值 来 比 较 其 实 仍 然 是 一 种 赌 概 率 的 解 决 办 法， 也 就 是 说 假 如 某 次 Minor GC 存 活 后 的 对 象 突 增， 远 远 高 于 历 史 平 均 值 的 话， 依 然 会 导 致 担 保 失 败。 如 果 出 现 了 担 保 失 败， 那 就 只 好 老 老 实 实 地 重 新 发 起 一 次 Full GC， 这 样 停 顿 时 间 就 很 长 了。 虽 然 担 保 失 败 时 绕 的 圈 子 是 最 大 的， 但 通 常 情 况 下 都 还 是 会 将-XX：HandlePromotionFailure 开 关 打 开， 避 免 Full GC 过 于 频 繁。

```
在 JDK 6 Update 24 之 后，-XX：HandlePromotionFailure 参 数 不 会 再 影 响 到 虚 拟 机 的 空 间 分 配 担 保 策 略， 观 察 OpenJDK 中 的 源 码 变 化（ 见 代 码 清 单 3-12）， 虽 然 源 码 中 还 定 义 了-XX：HandlePromotionFailure 参 数， 但 是 在 实 际 虚 拟 机 中 已 经 不 会 再 使 用 它。 JDK 6 Update 24 之 后 的 规 则 变 为 只 要 老 年 代 的 连 续 空 间 大 于 新 生 代 对 象 总 大 小 或 者 历 次 晋 升 的 平 均 大 小， 就 会 进 行 Minor GC， 否 则 将 进 行 Full GC。
```

