# Redis持久化(一）——RDB

参考：https://www.cnblogs.com/ysocean/p/9114268.html

redis是一个缓存类型的数据库，所有的数据都存储在内存中，因此是属于掉电易失的，所以需要一种手段将内存中的数据持久化到磁盘中，这便是RDB和AOF，本文主要介绍RDB

## 一、RDB简介

RDB(Redis Database)是Redis默认用来进行持久化的一种方式，是把当前内存中的数据集快照写入磁盘，也就是 Snapshot 快照。恢复时是将快照文件直接读到内存里。



## 二、RDB触发方式

### 自动触发

在前面介绍的redis.conf配置文件中的save选项中可以找到，形如——

```
save 900 1
save 100 10
save 60 10000
```

即若每m秒至少有n次写，则触发RDB机制

### 手动触发

**save**

save指令会阻塞住redis主进程，这意味着所有发往redis的请求都会被阻塞住，直到RDB完成才会继续

**bgsave**

令redis主进程fork出一个进程来完成rdb工作，这样不会导致阻塞的发生



## 三、数据恢复

redis.conf文件中配置了RDB产生的.dump文件的路径，找到dump文件后，将文件移动到redis安装目录后启动redis服务即可。

可以在redis客户端中通过执行config get dir获取redis安装目录。



## 四、RDB的优点

1.RDB是一个非常紧凑的文件,它保存了某个时间点得数据集,非常适用于数据集的备份,比如你可以在每个小时报保存一下过去24小时内的数据,同时每天保存过去30天的数据,这样即使出了问题你也可以根据需求恢复到不同版本的数据集.

2.RDB是一个紧凑的单一文件,很方便传送到另一个远端数据中心或者亚马逊的S3（可能加密），非常适用于灾难恢复.

3.RDB在保存RDB文件时父进程唯一需要做的就是fork出一个子进程,接下来的工作全部由子进程来做，父进程不需要再做其他IO操作，所以RDB持久化方式可以最大化redis的性能.

4.与AOF相比,在恢复大的数据集的时候，RDB方式会更快一些.



## 五、RDB的缺点

- 如果希望在redis，意外停止工作（例如电源中断）的情况下丢失的数据最少的话，那么RDB不适合。虽然可以配置不同的save时间点(例如每隔5分钟并且对数据集有100个写的操作)，但是Redis要完整的保存整个数据集是一个比较繁重的工作,你通常会每隔5分钟或者更久做一次完整的保存，万一在Redis意外宕机，可能会丢失几分钟的数据.
- RDB 需要经常fork子进程来保存数据集到硬盘上,当数据集比较大的时候,fork的过程是非常耗时的,可能会导致Redis在一些毫秒级内不能响应客户端的请求.如果数据集巨大并且CPU性能不是很好的情况下,这种情况会持续1秒,AOF也需要fork,但是你可以调节重写日志文件的频率来提高数据集的耐久度.



## *六、Copy-On-Write

rdb在做数据备份时，会创建一个子进程来做dump，照常理来说，子进程需要拥有一个主进程的数据备份，如果按照正常操作，那么子进程需要复制一份全量的redis缓存，这会导致内存瞬间翻倍，很有可能会产生问题。因此redis使用了copy-on-write(写时复制)技术，即子进程中备份的数据指针指向主进程中的数据地址，当需要备份的数据产生了写变化，此时才对原来的数据复制到子进程中。