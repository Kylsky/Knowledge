# 计算机网络(四)——网络层：数据平面

## 一、概述

网络层是协议栈中最复杂的一层，提供了单一的称为**尽力而为服务**，传送的分组既不能保证发送顺序被接收，也不能保证最终交付；即不能保证端到端时延，也不能保证有最小的带宽。能够被分解为两个相互作用的部分——数据平面和控制平面，**数据平面**的主要作用是从路由器的输入链路向其输出链路转发数据包，**转发**是在数据平面中实现的唯一功能。**控制平面**的主要作用是协调路由器的本地转发动作，使得数据报沿着源和目的主机之间的路由器路径最终进行端到端传送，控制平面则实现了**路由选择**，本章首先讨论数据平面。



## 二、路由器工作原理

数据平面的主要功能为**转发**，即将分组从一台路由器的入链路传送到适当的出链路。路由器的体系结构如下：

![img](http://kylescloud.top/site/pic/luyouqi.png)

### 输入端口

①在路由器中执行终结入物理链路的物理层功能

②与位于入链路远端的数据链路层交互来执行数据链路层功能

③查找功能，通过查询转发表决定路由器的输出端口

**线路端接功能**和**链路层处理**实现了用于各个输入链路的物理层和链路层，之后，路由器使用转发表**查找**输出端口，等待排队，然后转发到交换结构中。路由器用分组目的地址的前缀与转发表中的表项进行匹配，当一个地址有多个匹配前缀时，路由器一般使用最长前缀匹配规则。

![img](http://kylescloud.top/site/pic/shurudkcl.png)



### 交换结构

将路由器的输入端口连接到它的输出端口，交换结构位于路由器的核心部分，交换可以用许多方式完成

**内存交换**

**总线交换**

**互联网络交换**



### 输出端口

存储从减缓结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组

![img](http://kylescloud.top/site/pic/shuchudkcl.png)

### 路由选择处理器

执行控制平面功能，在**传统路由器**中，执行路由选择协议，维护路由表与关联链路状态信息，并未该路由器计算转发表。在**SDN路由器**中，路由选择处理器负责与远端控制器通信，目的是接收远程控制器计算的转发表项。



### 排队问题

#### 输入排队

在输入端口中，一个输入队列中排队的分组必须等待通过交换结构发送，因为它被位于线路前部的另一个分组所阻塞，这种阻塞称为**线路前部阻塞**（HOL，Head-Of-the-Line）。由于HOL阻塞，若输入链路上的分组到达速率达到输入端口的排队队列容量的58%，在某些假设前提下，输入队列长度就将无限制地增大。



#### 输出排队

假设到达N个输入端口地目的地是相同的输出端口，在向输出链路发送一个分组的时间内，将有N个新分组到达输出端口，因为输出端口在单一时间内只能传送一个分组，新到达的N个分组必须等待，当没有足够的内存来缓存一个分组，就可能会导致丢弃分组策略运行。有许多分组丢弃和标记策略，这些策略统称为**主动队列管理**（active queue management，AQM）。最广泛研究的AQM算法之一有随机早期检测算法。

当N个分组到达输出端口时，输出端口的**分组调度**在这些排队分组中选择一个分组来传输，分组调度主要有以下类别

**1.先进先出**

**2.优先权排队**

将分组进行分类，分别筛选为高优先权队列和低优先权队列，同一类优先权的分组之间以先进先出的规则输出到链路

**3.循环和加权公平排队**

创建n个公平的队列，通过轮询将队列中的分组取出发送给链路，与循环队列不同指出在于，不同队列占据不同带宽的权重。



## 三、IPv4

### IPv4数据报格式

**版本号**

4比特，规定了数据包的IP协议版本，通过查看版本号，路由器能确定如何解释IP数据报的剩余部分。

**首部长度**

4比特，确定IP数据报中荷载实际开始的地方，一般IP数据报首部为20字节

**服务类型**

使不同类型的IP数据报能够被区别，如一些特别要求低时延、高吞吐量或可靠性的数据报。

**数据报长度**

16比特。IP数据报的总长度，以字节计，因此IP数据报理论最大长度为65535字节

**标识、标志、片偏移**

与IP分片有关

**寿命**

用于确保数据报不会永远在网络中循环。每一台路由器处理数据报时，将该字段值-1，若寿命为0，则需要丢弃该数据报

**首部检验和**

帮助路由器检测收到的IP数据报中的比特差错

**源和目的IP地址**

源IP和目的地IP地址

**选项**

通常为空

**数据**

包含运输层首部+应用层数据



### IPv4数据报分片

并不是所有链路层协议都能承载相同长度的网络层分组，有的协议能承载大叔举报，而有的协议不能。一个链路层**帧**能承载的最大数据量叫做**最大传送单元**。当IP数据报过大时，需要将IP数据报中的数据分片成两个或更多的较小的IP数据报。数据报的重新组装一般在端系统中，而不是网络路由器中。IP数据报分片细节如下：

1.当生成一个数据报，发送主机设置源和目的地IP地址，同时加上**标识**号（即标识字段）。发送主机通常将发送的每个数据报的标识号加1。目的地收到这一些列数据报时，能够检查数据报的标识号以确定哪些数据包实际上是同一较大数据报的片

2.由于IP是不可靠服务，为了让目的主机绝对相信已经收到了分片的数据报的最后一片，发送主机将最后一片的**标志**字段设为0，而所有其他片设为1

3.为了让目的主机确定是否有分片丢失，使用**偏移**字段指定该片应当放在初始IP数据报的哪个位置



### IPv4编址

#### 接口

主机与物理链路之间的边界叫做**接口**，一个IP地址与一个接口相关联，而不是与包括该接口的主机或路由器相关联。



#### 点分十进制

IP地址由32位组成，点分十进制记法将地址中的每个字节用十进制形式书写，以句号隔开。



#### 子网

1一个或多个主机接口和1个路由器接口之间形成的网络能形成一个子网。子网IP通常形如223.1.1.0/24，24意为255.255.255.0，是子网掩码。即223.1.1.0的最左侧24位比特定义了子网地址（网络号），右边八位则定义了可分配给主机及路由器的主机地址（主机号）



#### **动态主机配置协议**（DHCP）

DHCP（Dynamic Host Configuration Protocal）可以用于给定主机一个临时的IP地址，还允许一台主机得知其他信息，如子网掩码、第一跳路由器地址（通常称为默认网关）、本地DNS服务器地址。DHCP又被称为即插即用协议或零配置协议。DHCP工作原理如下：

**1.DHCP服务器发现**

一台新的主机进入网络，首先通过UDP向端口67发送DHCP发现报文，之后进入网络成生成IP数据报，广播目的地址为255.255.255.255，源IP地址为0.0.0.0，随后链路层将帧广播到当前子网连接的节点

**2.DHCP服务提供**

DHCP收到发现保温，用DHCP提供报文向客户做出响应，该报文向所有子网节点广播。每个报文包含收到的发现报文的事务ID、向客户推荐的IP地址、网络掩码、IP地址租用期

**3.DHCP请求**

新到达的主机从一个或多个DHCP服务器中选择一个，并向选中的服务器提供DHCP请求报文进行相应，回显配置的参数

**4.DHCP ACK**

服务器用DHCP ACK报文对DHCP请求报文进行响应



#### 网络地址转换（NAT）

NAT流程：

1.用户使用主机IP地址如10.0.0.1请求ip地址如119.23.64.11服务器的80端口的一个页面。主机使用一个套接字向服务器进行连接，假设端口为8888

2.NAT路由器收到数据报，将源IP10.0.0.1代替为自身在广域网一侧的接口IP如123.22.22.22，并为数据报生成一个新的端口2233，此时数据报中**源ip地址以及端口**被修改为路由器的外网ip地址及端口，将新的两个数据和旧的两个数据存入了NAT转换表，新的为WAN端，旧的为LAN端。此时路由器发送数据报到目标ip地址

3.路由器WAN端从服务器收到响应的数据报，再通过NAT转换表转发响应到LAN端