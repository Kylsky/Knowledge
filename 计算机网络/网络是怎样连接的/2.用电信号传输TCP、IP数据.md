## 1.前情提要

第 1 章， 我 们 从 解 析 浏 览 器 中 输 入 的 网 址 开 始， 探 索 了 生 成 HTTP 请 求 消 息、 委 托 操 作 系 统 发 送 消 息 等 步 骤。 本 章， 我 们 将 讲 解 操 作 系 统 中 的 协 议 栈 是 如 何 处 理 数 据 发 送 请 求 的。 第 1 章 介 绍 了 发 送 消 息 的 场 景， 接 下 来 我 们 将 视 角 切 换 到 索 操 作 系 统 中 的 网 络 控 制 软 件（ 协 议 栈） 和 网 络 硬 件 来 继 续 探 索 。

![image-20200817102227078](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102227078.png)



## 2.要点

### 2.1 创建套接字：socket

和 浏 览 器 不 同 的 是， 协 议 栈 的 工 作 我 们 从 表 面 上 是 看 不 见 的， 可 能 比 较 难 以 想 象。 因 此， 在 实 际 探 索 之 前， 我 们 先 来 对 协 议 栈 做 个 解 剖：

协 议 栈 的 内 部 如 图 所 示， 分 为 几 个 部 分， 分 别 承 担 不 同 的 功 能。 这 张 图 中 的 上 下 关 系 是 有 一 定 规 则 的， 上 面 的 部 分 会 向 下 面 的 部 分 委 派 工 作， 下 面 的 部 分 接 受 委 派 的 工 作 并 实 际 执 行， 这 一 点 大 家 在 看 图 时 可 以 参 考 一 下。 当 然， 这 一 上 下 关 系 只 是 一 个 总 体 的 规 则， 其 中 也 有 一 部 分 上 下 关 系 不 明 确， 或 者 上 下 关 系 相 反 的 情 况， 所 以 也 不 必 过 于 纠 结。 此 外， 对 于 图 中 的 每 个 部 分 以 及 它 们 的 工 作 方 式， 本 章 将 按 顺 序 进 行 介 绍， 因 此 对 于 里 面 的 细 节 现 在 看 不 明 白 也 没 关 系， 只 要 大 体 上 看 出 有 哪 些 组 成 要 素 就 可 以 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102702690.png" alt="image-20200817102702690" style="zoom:67%;" />



#### 2.1.1 关于套接字

在 协 议 栈 内 部 有 一 块 用 于 存 放 控 制 信 息 的 内 存 空 间， 这 里 记 录 了 用 于 控 制 通 信 操 作 的 控 制 信 息， 例 如 通 信 对 象 的 IP 地 址、 端 口 号、 通 信 操 作 的 进 行 状 态 等。 本 来 套 接 字 就 只 是 一 个 概 念 而 已， 并 不 存 在 实 体， 如 果 一 定 要 赋 予 它 一 个 实 体， 我 们 可 以 说 这 些 控 制 信 息 就 是 套 接 字 的 实 体， 或 者 说 存 放 控 制 信 息 的 内 存 空 间 就 是 套 接 字 的 实 体。

协 议 栈 在 执 行 操 作 时 需 要 参 阅 这 些 控 制 信 息。 例 如， 在 发 送 数 据 时， 需 要 看 一 看 套 接 字 中 的 通 信 对 象 **IP 地 址** 和 **端 口 号**， 以 便 向 指 定 的 IP 地 址 和 端 口 发 送 数 据。 在 发 送 数 据 之 后， 协 议 栈 需 要 等 待 对 方 返 回 收 到 数 据 的 响 应 信 息， 但 数 据 也 可 能 在 中 途 丢 失， 永 远 也 等 不 到 对 方 的 响 应。 在 这 样 的 情 况 下， 我 们 不 能 一 直 等 下 去， 需 要 在 等 待 一 定 时 间 之 后 重 新 发 送 丢 失 的 数 据， 这 就 需 要 协 议 栈 能 够 知 道 执 行 发 送 数 据 操 作 后 过 了 多 长 时 间。 为 此， 套 接 字 中 必 须 要 记 录 **是 否 已 经 收 到 响 应**， 以 及 发 送 数 据 后 **经 过 了 多 长 时 间**， 才 能 根 据 这 些 信 息 按 照 需 要 执 行 重 发 操 作。

以下是windows上的套接字示例：

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817103910057.png" alt="image-20200817103910057" style="zoom: 67%;" />



#### 2.1.2 调用socket时的操作

在 这 个 过 程 中， 协 议 栈 首 先 会 分 配 用 于 存 放 一 个 套 接 字 所 需 的 内 存 空 间。 用 于 记 录 套 接 字 控 制 信 息 的 内 存 空 间 并 不 是 一 开 始 就 存 在 的， 因 此 我 们 先 要 开 辟 出 这 样 一 块 空 间 来， 这 相 当 于 为 控 制 信 息 准 备 一 个 容 器。 但 光 一 个 容 器 并 没 有 什 么 用， 还 需 要 往 里 面 存 入 控 制 信 息。 套 接 字 刚 刚 创 建 时， 数 据 收 发 操 作 还 没 有 开 始， 因 此 需 要 在 套 接 字 的 内 存 空 间 中 写 入 表 示 这 一 初 始 状 态 的 控 制 信 息。 到 这 里， 创 建 套 接 字 的 操 作 就 完 成 了。

```
计 算 机 内 部 会 同 时 运 行 多 个 程 序， 如 果 每 个 程 序 都 擅 自 使 用 内 存 空 间 的 话， 就 有 可 能 发 生 多 个 程 序 重 复 使 用 同 一 个 内 存 区 域 导 致 数 据 损 坏 的 问 题。 为 了 避 免 出 现 这 样 的 问 题， 操 作 系 统 中 有 一 个“ 内 存 管 理” 模 块， 它 相 当 于 内 存 的 管 理 员， 负 责 根 据 程 序 的 申 请 分 配 相 应 的 内 存 空 间， 并 确 保 这 些 内 存 空 间 不 会 被 其 他 程 序 使 用。 因 此， 分 配 内 存 的 操 作 就 是 向 内 存 管 理 模 块 提 出 申 请， 请 它 划 分 一 块 内 存 空 间 出 来。
```

接 下 来， 需 要 将 表 示 这 个 套 接 字 的 描 述 符 告 知 应 用 程 序。 描 述 符 相 当 于 用 来 区 分 协 议 栈 中 的 多 个 套 接 字 的 号 码 牌。 收 到 描 述 符 之 后， 应 用 程 序 在 向 协 议 栈 进 行 收 发 数 据 委 托 时 就 需 要 提 供 这 个 描 述 符。 由 于 套 接 字 中 记 录 了 通 信 双 方 的 信 息 以 及 通 信 处 于 怎 样 的 状 态， 所 以 只 要 通 过 描 述 符 确 定 了 相 应 的 套 接 字， 协 议 栈 就 能 够 获 取 所 有 的 相 关 信 息， 这 样 一 来， 应 用 程 序 就 不 需 要 每 次 都 告 诉 协 议 栈 应 该 和 谁 进 行 通 信 了。



### 2.2 连接服务器：connect

#### 2.2.1 连接

创 建 套 接 字 之 后， 应 用 程 序（ 浏 览 器） 就 会 调 用 connect， 随 后 协 议 栈 会 将 本 地 的 套 接 字 与 服 务 器 的 套 接 字 进 行 连 接。

套 接 字 刚 刚 创 建 完 成 的 时 候， 里 面 并 没 有 存 放 任 何 数 据， 也 不 知 道 通 信 的 对 象 是 谁。 在 这 个 状 态 下， 即 便 应 用 程 序 要 求 发 送 数 据， 协 议 栈 也 不 知 道 数 据 应 该 发 送 给 谁。 浏 览 器 可 以 根 据 网 址 来 查 询 服 务 器 的 IP 地 址， 而 且 根 据 规 则 也 知 道 应 该 使 用 80 号 端 口， 但 只 有 浏 览 器 知 道 这 些 必 要 的 信 息 是 不 够 的， 因 为 在 调 用 socket 创 建 套 接 字 时， 这 些 信 息 并 没 有 传 递 给 协 议 栈。 因 此， 我 们 需 要 把 服 务 器 的 **IP 地 址** 和 **端 口 号** 等 信 息 告 知 协 议 栈， 这 是 连 接 操 作 的 目 的 之 一。

那 么， 服 务 器 这 边 又 是 怎 样 的 情 况 呢？ 服 务 器 上 也 会 创 建 套 接 字， 但 服 务 器 上 的 协 议 栈 和 客 户 端 一 样， 只 创 建 套 接 字 是 不 知 道 应 该 和 谁 进 行 通 信 的。 而 且， 和 客 户 端 不 同 的 是， 在 服 务 器 上， 连 应 用 程 序 也 不 知 道 通 信 对 象 是 谁， 这 样 下 去 永 远 也 没 法 开 始 通 信。 于 是， 我 们 需 要 让 客 户 端 向 服 务 器 告 知 必 要 的 信 息， 比 如“ 我 想 和 你 开 始 通 信， 我 的 IP 地 址 是 xxx.xxx.xxx.xxx， 端 口 号 是 yyyy。” 可 见， 客 户 端 向 服 务 器 传 达 开 始 通 信 的 请 求， 也 是 连 接 操 作 的 目 的 之 一。



#### 2.2.2 负 责 保 存 控 制 信 息 的 头 部

之 前 我 们 说 的 控 制 信 息 其 实 可 以 大 体 上 分 为 两 类。 

**第 一 类** 是 客 户 端 和 服 务 器 相 互 联 络 时 交 换 的 控 制 信 息。 这 些 信 息 不 仅 连 接 时 需 要， 包 括 数 据 收 发 和 断 开 连 接 操 作 在 内， 整 个 通 信 过 程 中 都 需 要， 这 些 内 容 在 TCP 协 议 的 规 格 中 进 行 了 定 义。 具 体 来 说， 表 中 的 这 些 字 段 就 是 TCP 规 格 中 定 义 的 控 制 信 息 。 这 些 字 段 是 固 定 的， 在 连 接、 收 发、 断 开 等 各 个 阶 段 中， 每 次 客 户 端 和 服 务 器 之 间 进 行 通 信 时， 都 需 要 提 供 这 些 控 制 信 息。

这 些 信 息 会 被 添 加 在 客 户 端 与 服 务 器 之 间 传 递 的 网 络 包 的 开 头。 在 连 接 阶 段， 由 于 数 据 收 发 还 没 有 开 始（要进行三次握手）， 网 络 包 中 没 有 实 际 的 数 据， 只 有 控 制 信 息。 这 些 控 制 信 息 位 于 网 络 包 的 开 头， 因 此 被 称 为 头 部。 此 外， 以 太 网 和 IP 协 议 也 有 自 己 的 控 制 信 息， 这 些 信 息 也 叫 头 部， 为 了 避 免 各 种 不 同 的 头 部 发 生 混 淆， 我 们 一 般 会 记 作 TCP 头 部（传输层)、 以 太 网 头 部 （链路层）、 IP 头 部（网络层）。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193236791.png" alt="image-20200818193236791" style="zoom:67%;" />

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193250728.png" alt="image-20200818193250728" style="zoom:67%;" />

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193355430.png" alt="image-20200818193355430" style="zoom:67%;" />

控 制 信 息 还 有 **另 外 一 类**， 那 就 是 保 存 在 套 接 字 中， 用 来 控 制 协 议 栈 操 作 的 信 息。 应 用 程 序 传 递 来 的 信 息 以 及 从 通 信 对 象 接 收 到 的 信 息 都 会 保 存 在 这 里， 还 有 收 发 数 据 操 作 的 执 行 状 态 等 信 息 也 会 保 存 在 这 里， 协 议 栈 会 根 据 这 些 信 息 来 执 行 每 一 步 的 操 作。 我 们 可 以 说， 套 接 字 的 控 制 信 息 和 协 议 栈 的 程 序 本 身 其 实 是 一 体 的， 因 此，“ 协 议 栈 具 体 需 要 哪 些 信 息” 会 根 据 协 议 栈 本 身 的 实 现 方 式 不 同 而 不 同， 但 这 并 没 有 什 么 问 题。 因 为 **协 议 栈 中 的 控 制 信 息 通 信 对 方 是 看 不 见 的**， 只 要 在 通 信 时 按 照 规 则 将 必 要 的 信 息 写 入 头 部， 客 户 端 和 服 务 器 之 间 的 通 信 就 能 够 得 以 成 立。 

例 如， Windows 和 Linux 操 作 系 统 的 内 部 结 构 不 同， 协 议 栈 的 实 现 方 式 不 同， 必 要 的 控 制 信 息 也 就 不 同。 但 即 便 如 此， 两 种 系 统 之 间 依 然 能 够 互 相 通 信， 同 样 地， 计 算 机 和 手 机 之 间 也 能 够 互 相 通 信。 正 如 前 面 所 说， 协 议 栈 的 实 现 不 同， 因 此 我 们 无 法 具 体 说 明 协 议 栈 里 到 底 保 存 了 哪 些 控 制 信 息， 但 可 以 用 命 令 来 显 示 一 些 重 要 的 套 接 字 控 制 信 息，如 下 图。 这 些 信 息 无 论 何 种 操 作 系 统 的 协 议 栈 都 是 共 通 的， 通 过 理 解 这 些 重 要 信 息， 就 能 够 理 解 协 议 栈 的 工 作 方 式 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817103910057.png" alt="image-20200817103910057" style="zoom: 67%;" />



#### 2.2.3 连接操作实际过程

**connect **系 统 调 用 提 供 了 服 务 器 的 IP 地 址 和 端 口 号， 这 些 信 息 会 传 递 给 协 议 栈 中 的 TCP 模 块。 然 后， TCP 模 块 会 与 服 务 器 的 TCP 模 块 交 换 控 制 信 息，如 果 你 正 在 精 心 准 备 一 场 面 试 ，你 会 发 现 这 就 是 在 进 行 TCP的 “ 三 次 握 手”， 这 一 交 互 过 程 包 括 下 面 几 个 步 骤：

**第 一 步**， 客 户 端 先 创 建 一 个 包 含 表 示 开 始 数 据 收 发 操 作 的 控 制 信 息 的 头 部。 头 部 包 含 很 多 字 段， 这 里 要 关 注 的 重 点 是 发 送 方 和 接 收 方 的 端 口 号。 到 这 里， 客 户 端（ 发 送 方） 的 套 接 字 就 准 确 定 位 了 服 务 器（ 接 收 方） 的 套 接 字， 也 就 是 搞 清 楚 了 我 应 该 连 接 哪 个 套 接 字。 然 后， 将 头 部 中 的 控 制 位 的 **SYN 比 特 设 置 为 1**， 可 以 认 为 它 表 示 连 接。 **此 外 还 需 要** 设 置 适 当 的 序 号 和 窗 口 大 小， 这 一 点 我 们 会 稍 后 详 细 讲 解。

**第 二 步**，当 TCP 头 部 创 建 好 之 后， 接 下 来 TCP 模 块 会 将 信 息 传 递 给 IP 模 块 并 委 托 它 进 行 发 送 。 IP 模 块 执 行 网 络 包 发 送 操 作 后， 网 络 包 就 会 通 过 网 络 到 达 服 务 器， 然 后 服 务 器 上 的 IP 模 块 会 将 接 收 到 的 数 据 传 递 给 TCP 模 块， 服 务 器 的 TCP 模 块 根 据 TCP 头 部 中 的 信 息 找 到 端 口 号 对 应 的 套 接 字， 也 就 是 说， 从 处 于 等 待 连 接 状 态 的 套 接 字 中 找 到 与 TCP 头 部 中 记 录 的 端 口 号 相 同 的 套 接 字 就 可 以 了。 当 找 到 对 应 的 套 接 字 之 后， 套 接 字 中 会 写 入 相 应 的 信 息， 并 将 状 态 改 为 正 在 连 接。 上 述 操 作 完 成 后， 服 务 器 的 TCP 模 块 会 返 回 响 应， 这 个 过 程 和 客 户 端 一 样， 需 要 在 TCP 头 部 中 设 置 **发 送 方 和 接 收 方 端 口 号 以 及 SYN 比 特**。 此 外， 在 返 回 响 应 时 还 需 要 将 ACK 控 制 位 设 为 1， 这 表 示 已 经 接 收 到 相 应 的 网 络 包。 网 络 中 经 常 会 发 生 错 误， 网 络 包 也 会 发 生 丢 失， 因 此 双 方 在 通 信 时 必 须 相 互 确 认 网 络 包 是 否 已 经 送 达， 而 设 置 ACK 比 特 就 是 用 来 进 行 这 一 确 认 的。 接 下 来， 服 务 器 TCP 模 块 会 将 TCP 头 部 传 递 给 IP 模 块， 并 委 托 IP 模 块 向 客 户 端 返 回 响 应。

**第 三 步**， 网 络 包 会 返 回 到 客 户 端， 通 过 IP 模 块 到 达 TCP 模 块， 并 通 过 TCP 头 部 的 信 息 确 认 连 接 服 务 器 的 操 作 是 否 成 功。 如 果 SYN 为 1 则 表 示 连 接 成 功， 这 时 会 向 套 接 字 中 写 入 服 务 器 的 IP 地 址、 端 口 号 等 信 息， 同 时 **还 会 将 状 态 改 为 连 接 完 毕**。 到 这 里， 客 户 端 的 操 作 就 已 经 完 成， 但 其 实 还 剩 下 最 后 一 个 步 骤。 刚 才 服 务 器 返 回 响 应 时 将 ACK 比 特 设 置 为 1， 相 应 地， 客 户 端 也 需 要 将 ACK 比 特 设 置 为 1 并 发 回 服 务 器， 告 诉 服 务 器 刚 才 的 响 应 包 已 经 收 到。 当 这 个 服 务 器 收 到 这 个 返 回 包 之 后， 连 接 操 作 才 算 全 部 完 成。 

建 立 连 接 之 后， 协 议 栈 的 连 接 操 作 就 结 束 了， 也 就 是 说 connect 已 经 执 行 完 毕， 控 制 流 程 被 交 回 到 应 用 程 序。



### 2.3 收发数据

#### 2.3.1 协议栈的消息处理

当 控 制 流 程 从 connect 回 到 应 用 程 序 之 后， 接 下 来 就 进 入 数 据 收 发 阶 段 了。 数 据 收 发 操 作 是 从 应 用 程 序 调 用 write 将 要 发 送 的 数 据 交 给 协 议 栈 开 始 的， 协 议 栈 收 到 数 据 后 执 行 发 送 操 作， 这 一 操 作 包 含 如 下 要 点。 

首 先， 协 议 栈 并 不 关 心 应 用 程 序 传 来 的 数 据 是 什 么 内 容。 应 用 程 序 在 调 用 write 时 会 指 定 发 送 数 据 的 长 度， 在 协 议 栈 看 来， 要 发 送 的 数 据 就 是 一 定 长 度 的 二 进 制 字 节 序 列 而 已。 

其 次， 协 议 栈 并 不 是 一 收 到 数 据 就 马 上 发 送 出 去， 而 是 会 将 数 据 存 放 在 内 部 的 发 送 缓 冲 区 中， 并 等 待 应 用 程 序 的 下 一 段 数 据。 这 样 做 是 有 道 理 的。 应 用 程 序 交 给 协 议 栈 发 送 的 数 据 长 度 是 由 应 用 程 序 本 身 来 决 定 的， 不 同 的 应 用 程 序 在 实 现 上 有 所 不 同， 有 些 程 序 会 一 次 性 传 递 所 有 的 数 据， 有 些 程 序 则 会 逐 字 节 或 者 逐 行 传 递 数 据。 总 之， 一 次 将 多 少 数 据 交 给 协 议 栈 是 由 应 用 程 序 自 行 决 定 的， 协 议 栈 并 不 能 控 制 这 一 行 为。 

在 这 样 的 情 况 下， 如 果 一 收 到 数 据 就 马 上 发 送 出 去， 就 可 能 会 发 送 大 量 的 小 包， 导 致 网 络 效 率 下 降， 因 此 需 要 在 数 据 积 累 到 一 定 量 时 再 发 送 出 去。 至 于 要 积 累 多 少 数 据 才 能 发 送， 不 同 种 类 和 版 本 的 操 作 系 统 会 有 所 不 同， 不 能 一 概 而 论， 但 都 是 根 据 下 面 几 个 要 素 来 判 断 的。 

**第 一 个** 判 断 要 素 是 每 个 网 络 包 能 容 纳 的 数 据 长 度， 协 议 栈 会 根 据 一 个 叫 作 MTU27 的 参 数 来 进 行 判 断。 MTU27（Maximum Transmission Unit）表 示 一 个 网 络 包 的 最 大 长 度， 在 以 太 网 中 一 般 是 1500 字 节。 MTU 是 包 含 头 部 的 总 长 度， 因 此 需 要 从 MTU 减 去 头 部 的 长 度， 然 后 得 到 的 长 度 就 是 一 个 网 络 包 中 所 能 容 纳 的 最 大 数 据 长 度， 这 一 长 度 叫 作 MSS（Maximum Segment Size）。 当 从 应 用 程 序 收 到 的 数 据 长 度 超 过 或 者 接 近 MSS 时 再 发 送 出 去， 就 可 以 避 免 发 送 大 量 小 包 的 问 题 了。

```
在使用PPPoE的ADSL等网络中，需要额外增加一些头部数 据， 因此 MTU 会 小 于 1500 字 节。
```

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824093920798.png" alt="image-20200824093920798" style="zoom:67%;" />

**另 一 个** 判 断 要 素 是 时 间。 当 应 用 程 序 发 送 数 据 的 频 率 不 高 的 时 候， 如 果 每 次 都 等 到 长 度 接 近 MSS 时 再 发 送， 可 能 会 因 为 等 待 时 间 太 长 而 造 成 发 送 延 迟， 这 种 情 况 下， 即 便 缓 冲 区 中 的 数 据 长 度 没 有 达 到 MSS， 也 应 该 果 断 发 送 出 去。 为 此， 协 议 栈 的 内 部 有 一 个 计 时 器， 当 经 过 一 定 时 间 之 后 （一般以毫秒为单位）， 就 会 把 网 络 包 发 送 出 去。

判 断 要 素 就 是 这 两 个， 但 它 们 其 实 是 互 相 矛 盾 的。 如 果 长 度 优 先， 那 么 网 络 的 效 率 会 提 高， 但 可 能 会 因 为 等 待 填 满 缓 冲 区 而 产 生 延 迟； 相 反 地， 如 果 时 间 优 先， 那 么 延 迟 时 间 会 变 少， 但 又 会 降 低 网 络 的 效 率。 因 此， 在 进 行 发 送 操 作 时 需 要 综 合 考 虑 这 两 个 要 素 以 达 到 平 衡。 不 过， TCP 协 议 规 格 中 并 没 有 告 诉 我 们 怎 样 才 能 平 衡， 因 此 实 际 如 何 判 断 是 由 协 议 栈 的 开 发 者 来 决 定 的， 也 正 是 由 于 这 个 原 因， 不 同 种 类 和 版 本 的 操 作 系 统 在 相 关 操 作 上 也 就 存 在 差 异。



#### 2.3.2  TCP分包

HTTP 请 求 消 息 一 般 不 会 很 长， 一 个 网 络 包 就 能 装 得 下， 但 如 果 其 中 要 提 交 表 单 数 据， 长 度 就 可 能 超 过 一 个 网 络 包 所 能 容 纳 的 数 据 量， 比 如 在 博 客 或 者 论 坛 上 发 表 一 篇 长 文 就 属 于 这 种 情 况。 这 种 情 况 下， 发 送 缓 冲 区 中 的 数 据 就 会 超 过 MSS 的 长 度， 这 时 我 们 当 然 不 需 要 继 续 等 待 后 面 的 数 据 了。 发 送 缓 冲 区 中 的 数 据 会 被 以 MSS 长 度 为 单 位 进 行 拆 分， 拆 分 出 来 的 每 块 数 据 会 被 放 进 单 独 的 网 络 包 中。 根 据 发 送 缓 冲 区 中 的 数 据 拆 分 的 情 况， 当 判 断 需 要 发 送 这 些 数 据 时， 就 在 每 一 块 数 据 前 面 加 上 TCP 头 部， 并 根 据 套 接 字 中 记 录 的 控 制 信 息 标 记 发 送 方 和 接 收 方 的 端 口 号， 然 后 交 给 IP 模 块 来 执 行 发 送 数 据 的 操 作。



#### 2.3.3 ACK确认机制

网 络 包 已 经 装 好 数 据 并 发 往 服 务 器 了， 但 数 据 发 送 操 作 还 没 有 结 束。 TCP 具 备 确 认 对 方 是 否 成 功 收 到 网 络 包， 以 及 当 对 方 没 收 到 时 进 行 重 发 的 功 能， 因 此 在 发 送 网 络 包 之 后， 接 下 来 还 需 要 进 行 确 认 操 作。

首 先， TCP 模 块 在 拆 分 数 据 时， 会 先 算 好 每 一 块 数 据 相 当 于 从 头 开 始 的 第 几 个 字 节， 接 下 来 在 发 送 这 一 块 数 据 时， 将 算 好 的 字 节 数 写 在 TCP 头 部 中，“ 序 号” 字 段 就 是 派 在 这 个 用 场 上 的。 然 后， 发 送 数 据 的 长 度 也 需 要 告 知 接 收 方， 不 过 这 个 并 不 是 放 在 TCP 头 部 里 面 的， 因 为 用 整 个 网 络 包 的 长 度 减 去 头 部 的 长 度 就 可 以 得 到 数 据 的 长 度， 所 以 接 收 方 可 以 用 这 种 方 法 来 进 行 计 算。 有 了 上 面 两 个 数 值， 我 们 就 可 以 知 道 发 送 的 数 据 是 从 第 几 个 字 节 开 始， 长 度 是 多 少 。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824095319676.png" alt="image-20200824095319676" style="zoom:67%;" />



例 如， 假 设 上 次 接 收 到 第 1460 字 节， 那 么 接 下 来 如 果 收 到 序 号 为 1461 的 包， 说 明 中 间 没 有 遗 漏； 但 如 果 收 到 的 包 序 号 为 2921， 那 就 说 明 中 间 有 包 遗 漏 了。 像 这 样， 如 果 确 认 没 有 遗 漏， 接 收 方 会 将 到 目 前 为 止 接 收 到 的 数 据 长 度 加 起 来， 计 算 出 一 共 已 经 收 到 了 多 少 个 字 节， 然 后 将 这 个 数 值 写 入 TCP 头 部 的 ACK 号 中 发 送 给 发 送 方。

在 实 际 的 通 信 中， 序 号 并 不 是 从 1 开 始 的， 而 是 需 要 用 随 机 数 计 算 出 一 个 初 始 值， 这 是 因 为 如 果 序 号 都 从 1 开 始， 通 信 过 程 就 会 非 常 容 易 预 测， 有 人 会 利 用 这 一 点 来 发 动 攻 击。 但 是 如 果 初 始 值 是 随 机 的， 那 么 对 方 就 搞 不 清 楚 序 号 到 底 是 从 多 少 开 始 计 算 的， 因 此 需 要 在 开 始 收 发 数 据 之 前 将 初 始 值 告 知 通 信 对 象， 就 是 在 TCP 第 一 次 握 手 时  将 序 号 的 初 始 值 告 知 对 方 的——在 将 SYN 设 为 1 的 同 时， 还 需 要 同 时 设 置 序 号 字 段 的 值， 而 这 里 的 值 就 代 表 序 号 的 初 始 值。

但 TCP 数 据 收 发 是 双 向 的， 在 客 户 端 向 服 务 器 发 送 数 据 的 同 时， 服 务 器 也 会 向 客 户 端 发 送 数 据， 因 此 必 须 要 想 办 法 应 对 这 样 的 情 况。 不 过， 这 其 实 也 不 难， 我 们 只 要 增 加 一 种 左 右 相 反 的 情 形 就 可 以 了。**首 先** 客 户 端 先 计 算 出 一 个 序 号， 然 后 将 序 号 和 数 据 一 起 发 送 给 服 务 器， 服 务 器 收 到 之 后 会 计 算 ACK 号。**同时**， 服 务 器 也 需 要 先 计 算 出 另 一 个 序 号， 然 后 将 序 号 和 数 据 一 起 发 送 给 客 户 端， 客 户 端 收 到 之 后 计 算 ACK 号 并 返 回 给 服 务 器。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824100605714.png" alt="image-20200824100605714" style="zoom:67%;" />

#### 2.3.4 ACK等待时间

当 网 络 传 输 繁 忙 时 就 会 发 生 拥 塞， ACK 号 的 返 回 会 变 慢， 这 时 我 们 就 必 须 将 等 待 时 间 设 置 得 稍 微 长 一 点， 否 则 可 能 会 发 生 已 经 重 传 了 包 之 后， 前 面 的 ACK 号 才 姗 姗 来 迟 的 情 况。 这 样 的 重 传 是 多 余 的， 看 上 去 只 是 多 发 一 个 包 而 已， 但 它 造 成 的 后 果 却 没 那 么 简 单。

正 因 为 波 动 如 此 之 大， 所 以 将 等 待 时 间 设 置 为 一 个 固 定 值 并 不 是 一 个 好 办 法。 因 此， TCP 采 用 了 动 态 调 整 等 待 时 间 的 方 法， 这 个 等 待 时 间 是 根 据 ACK 号 返 回 所 需 的 时 间 来 判 断 的。 具 体 来 说， TCP 会 在 发 送 数 据 的 过 程 中 持 续 测 量 ACK 号 的 返 回 时 间， 如 果 ACK 号 返 回 变 慢， 则 相 应 延 长 等 待 时 间； 相 对 地， 如 果 ACK 号 马 上 就 能 返 回， 则 相 应 缩 短 等 待 时 间。



#### 2.3.5 使用滑动窗口

每 发 送 一 个 包 就 等 待 一 个 ACK 号 的 方 式 是 最 简 单 也 最 容 易 理 解 的， 但 在 等 待 ACK 号 的 这 段 时 间 中， 如 果 什 么 都 不 做 那 实 在 太 浪 费 了。 为 了 减 少 这 样 的 浪 费， TCP 采 用 这 样 的 滑 动 窗 口 方 式 来 管 理 数 据 发 送 和 ACK 号 的 操 作。 所 谓 滑 动 窗 口， 就 是 在 发 送 一 个 包 之 后， 不 等 待 ACK 号 返 回， 而 是 直 接 发 送 后 续 的 一 系 列 包。 这 样 一 来， 等 待 ACK 号 的 这 段 时 间 就 被 有 效 利 用 起 来 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824101225780.png" alt="image-20200824101225780" style="zoom:67%;" />



#### 2.3.6 ACK与窗口的合并

接 收 方 在 发 送 ACK 号 和 窗 口 更 新 时， 并 不 会 马 上 把 包 发 送 出 去， 而 是 会 **等 待 一 段 时 间**， 在 这 个 过 程 中 很 有 可 能 会 出 现 其 他 的 通 知 操 作， 这 样 就 可 以 把 两 种 通 知 **合 并** 在 一 个 包 里 面 发 送 了。 举 个 例 子， 在 等 待 发 送 ACK 号 的 时 候 正 好 需 要 更 新 窗 口， 这 时 就 可 以 把 ACK 号 和 窗 口 更 新 放 在 一 个 包 里 发 送， 从 而 减 少 包 的 数 量。 **当 需 要 连 续 发 送 多 个 ACK 号 时**， 也 可 以 减 少 包 的 数 量， 这 是 因 为 ACK 号 表 示 的 是 已 收 到 的 数 据 量， 也 就 是 说， 它 是 告 诉 发 送 方 目 前 已 接 收 的 数 据 的 最 后 位 置 在 哪 里， 因 此 当 需 要 连 续 发 送 ACK 号 时， 只 要 发 送 最 后 一 个 ACK 号 就 可 以 了， 中 间 的 可 以 全 部 省 略。 **当 需 要 连 续 发 送 多 个 窗 口 更 新** 时 也 可 以 减 少 包 的 数 量， 因 为 连 续 发 生 窗 口 更 新 说 明 应 用 程 序 连 续 请 求 了 数 据， 接 收 缓 冲 区 的 剩 余 空 间 连 续 增 加。 这 种 情 况 和 ACK 号 一 样， 可 以 省 略 中 间 过 程， 只 要 发 送 最 终 的 结 果 就 可 以 了。



#### 2.3.7 接收Http响应

首 先， 协 议 栈 会 检 查 收 到 的 数 据 块 和 TCP 头 部 的 内 容， 判 断 是 否 有 数 据 丢 失， 如 果 没 有 问 题 则 返 回 ACK 号。 然 后， **协 议 栈 将 数 据 块 暂 存 到 接 收 缓 冲 区** 中， 并 将 数 据 块 按 顺 序 连 接 起 来 还 原 出 原 始 的 数 据， 最 后 将 数 据 交 给 应 用 程 序。 具 体 来 说， 协 议 栈 会 将 接 收 到 的 数 据 复 制 到 应 用 程 序 指 定 的 内 存 地 址 中， 然 后 将 控 制 流 程 交 回 应 用 程 序。 将 数 据 交 给 应 用 程 序 之 后， 协 议 栈 还 需 要 找 到 合 适 的 时 机 向 发 送 方 发 送 窗 口 更 新。



### 2.4 断开连接

#### 2.4.1 断开连接

收 发 数 据 结 束 的 时 间 点 应 该 是 应 用 程 序 判 断 所 有 数 据 都 已 经 发 送 完 毕 的 时 候。 这 时， 数 据 发 送 完 毕 的 一 方 会 发 起 断 开 过 程， 但 不 同 的 应 用 程 序 会 选 择 不 同 的 断 开 时 机。 以 Web 为 例， 浏 览 器 向 Web 服 务 器 发 送 请 求 消 息， Web 服 务 器 再 返 回 响 应 消 息， 这 时 收 发 数 据 的 过 程 就 全 部 结 束 了， 服 务 器 一 方 会 发 起 断 开 过 程 。 当 然， 可 能 也 有 一 些 程 序 是 客 户 端 发 送 完 数 据 就 结 束 了， 不 用 等 服 务 器 响 应， 这 时 客 户 端 会 先 发 起 断 开 过 程。 这 一 判 断 是 应 用 程 序 作 出 的， 协 议 栈 在 设 计 上 允 许 任 何 一 方 先 发 起 断 开 过 程。

无 论 哪 种 情 况， 完 成 数 据 发 送 的 一 方 会 发 起 断 开 过 程， 这 里 我 们 以 服 务 器 一 方 发 起 断 开 过 程 为 例 来 进 行 讲 解。 首 先， 服 务 器 一 方 的 应 用 程 序 会 调 用 Socket 库 的 close 程 序。 然 后， 服 务 器 的 协 议 栈 会 生 成 包 含 断 开 信 息 的 TCP 头 部， 具 体 来 说 就 是 将 控 制 位 中 的 **FIN 比 特 设 为 1**。 接 下 来， 协 议 栈 会 委 托 IP 模 块 向 客 户 端 发 送 数 据。 同 时， 服 务 器 的 套 接 字 中 也 会 记 录 下 断 开 操 作 的 相 关 信 息。

接 下 来 轮 到 客 户 端 了。 当 收 到 服 务 器 发 来 的 FIN 为 1 的 TCP 头 部 时， 客 户 端 的 协 议 栈 会 将 自 己 的 套 接 字 标 记 为 进 入 断 开 操 作 状 态。 然 后， 为 了 告 知 服 务 器 已 收 到 FIN 为 1 的 包， 客 户 端 会 向 服 务 器 返 回 一 个 ACK 号。 这 些 操 作 完 成 后， 客 户 端 的 协 议 栈 就 可 以 等 待 应 用 程 序 来 取 数 据 了。 过 了 一 会 儿， 应 用 程 序 就 会 调 用 read 来 读 取 数 据。 这 时， 客 户 端 协 议 栈 不 会 向 应 用 程 序 传 递 数 据（如 果 接 收 缓 冲 区 中 还 有 剩 余 的 已 接 收 数 据， 则 这 些 数 据 会 被 传 递 给 应 用 程 序）， 而 是 会 告 知 应 用 程 序（ 浏 览 器） 来 自 服 务 器 的 数 据 已 经 全 部 收 到 了。 根 据 规 则， 服 务 器 返 回 请 求 之 后， Web 通 信 操 作 就 全 部 结 束 了， 因 此 只 要 收 到 服 务 器 返 回 的 所 有 数 据， 客 户 端 的 操 作 也 就 随 之 结 束 了。 因 此， 客 户 端 应 用 程 序 会 调 用 close 来 结 束 数 据 收 发 操 作， 这 时 客 户 端 的 协 议 栈 也 会 和 服 务 器 一 样， 生 成 一 个 FIN 比 特 为 1 的 TCP 包， 然 后 委 托 IP 模 块 发 送 给 服 务 器。 一 段 时 间 之 后， 服 务 器 就 会 返 回 ACK 号。 到 这 里， 客 户 端 和 服 务 器 的 通 信 就 全 部 结 束 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824111228216.png" alt="image-20200824111228216" style="zoom:67%;" />



#### 2.4.2 删除套接字

和 服 务 器 的 通 信 结 束 之 后， 用 来 通 信 的 套 接 字 也 就 不 会 再 使 用 了， 这 时 我 们 就 可 以 删 除 这 个 套 接 字 了。 不 过， 套 接 字 并 不 会 立 即 被 删 除， 而 是 会 等 待 一 段 时 间 之 后 再 被 删 除。

至 于 具 体 等 待 多 长 时 间， 这 和 包 重 传 的 操 作 方 式 有 关。网 络 包 丢 失 之 后 会 进 行 重 传， 这 个 操 作 通 常 要 持 续 几 分 钟。 如 果 重 传 了 几 分 钟 之 后 依 然 无 效， 则 停 止 重 传。 在 这 段 时 间 内， 网 络 中 可 能 存 在 重 传 的 包， 也 就 有 可 能 发 生 前 面 讲 到 的 这 种 误 操 作， 因 此 需 要 等 待 到 重 传 完 全 结 束。 协 议 中 对 于 这 个 等 待 时 间 没 有 明 确 的 规 定， 一 般 来 说 会 等 待 几 分 钟 之 后 再 删 除 套 接 字。



### 2.5 IP与以太网

#### 2.5.1 包的基本知识

![image-20200824140019887](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824140019887.png)

![image-20200824140851022](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824140851022.png)



#### 2.5.2 包收发操作概览

包 收 发 操 作 的 起 点 是 TCP 模 块 委 托 IP 模 块 发 送 包 的 操 作。 这 个 委 托 的 过 程 就 是 TCP 模 块 在 数 据 块 的 前 面 加 上 TCP 头 部， 然 后 整 个 传 递 给 IP 模 块， 这 部 分 就 是 网 络 包 的 内 容。 与 此 同 时， TCP 模 块 还 需 要 指 定 通 信 对 象 的 IP 地 址， 也 就 是 需 要 写 清 楚“ 将 什 么 内 容 发 给 谁”。

![image-20200824141003623](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824141003623.png)

收 到 委 托 后， IP 模 块 会 将 包 的 内 容 当 作 一 整 块 数 据， 在 前 面 加 上 包 含 控 制 信 息 的 头 部。 刚 才 我 们 讲 过， IP 模 块 会 添 加 IP 头 部 和 MAC 头 部 这 两 种 头 部。 IP 头 部 中 包 含 IP 协 议 规 定 的、 根 据 IP 地 址 将 包 发 往 目 的 地 所 需 的 控 制 信 息； MAC 头 部 包 含 通 过 以 太 网 的 局 域 网 将 包 传 输 至 最 近 的 路 由 器 所 需 的 控 制 信 息。 关 于 IP 头 部 和 MAC 头 部 的 区 别 以 及 其 中 包 含 的 控 制 信 息 的 含 义， 我 们 将 稍 后 介 绍。 总 之， 加 上 这 两 个 头 部 之 后， 一 个 包 就 封 装 好 了， 这 些 就 是 IP 模 块 负 责 的 工 作。 



#### 2.5.3 IP头部

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824141142421.png" alt="image-20200824141142421" style="zoom:67%;" />

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824141154887.png" alt="image-20200824141154887" style="zoom:67%;" />

#### 2.5.4 MAC头部

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824141457736.png" alt="image-20200824141457736" style="zoom:67%;" />

接 收 方 MAC 地 址 有 点 复 杂 。一 般 地 ， 只 要 告 诉 以 太 网 对 方 的 MAC 的 地 址， 以 太 网 就 会 帮 我 们 把 包 发 送 过 去， 那 么 很 显 然 这 里 应 该 填 写 对 方 的 MAC 地 址。 然 而， 在 这 个 时 间 点 上， 我 们 现 在 根 本 不 知 道 对 方 的 MAC 地 址 是 什 么。 因 此， 我 们 还 需 要 执 行 根 据 IP 地 址 查 询 MAC 地 址 的 操 作。



#### 2.5.5 ARP 查 询 目 标 MAC 地 址

ARP：Address Resolution Protocol， 地 址 解 析 协 议，它 其 实 非 常 简 单。 在 以 太 网 中， 有 一 种 叫 作 广 播 的 方 法， 可 以 把 包 发 给 连 接 在 同 一 以 太 网 中 的 所 有 设 备。 ARP 就 是 利 用 广 播 对 所 有 设 备 提 问：“ × × 这 个 IP 地 址 是 谁 的？ 请 把 你 的 MAC 地 址 告 诉 我。” 然 后 就 会 有 人 回 答：“ 这 个 IP 地 址 是 我 的， 我 的 MAC 地 址 是 × × × ×。”

如 果 对 方 和 自 己 处 于 同 一 个 子 网 中， 那 么 通 过 上 面 的 操 作 就 可 以 得 到 对 方 的 MAC 地 址 71。 然 后， 我 们 将 这 个 MAC 地 址 写 入 MAC 头 部， MAC 头 部 就 完 成 了。

如 果 目 标 处 于 外 网 或 其 他 子 网 ，那 么 其 实 在 路 由 器 的 每 一 个 接 口 都 有 一 个 A R P 模 块 和 一 个 适 配 器 ，当 目 的 主 机 并 不 位 于 子 网 中，那 么 源 主 机 会 将 A R P 查 询 分 组 广 播 到 路 由 器 中 ，路 由 器 通 过 A R P 在 其 他 接 口 的 子 网 或 外 网 中 获 取 目 的 主 机 的 A R P 地 址 并 保存 在 A R P 表 中，并 向 源 主 机 发 送 A R P 响 应 分 组 。



#### 2.5.6 封装IP包并发送

下 面 来 看 看 以 太 网 的 包 收 发 操 作。 IP 生 成 的 网 络 包 只 是 存 放 在 内 存 中 的 一 串 数 字 信 息， 没 有 办 法 直 接 发 送 给 对 方。 因 此， 我 们 需 要 将 数 字 信 息 转 换 为 电 或 光 信 号， 才 能 在 网 线 上 传 输， 也 就 是 说， 这 才 是 真 正 的 数 据 发 送 过 程。 负 责 执 行 这 一 操 作 的 是 网 卡， 但 网 卡 也 无 法 单 独 工 作， 要 控 制 网 卡 还 需 要 网 卡 驱 动 程 序。 驱 动 程 序 不 只 有 网 卡 才 有， 键 盘、 鼠 标、 显 卡、 声 卡 等 各 种 硬 件 设 备 都 有。 当 然， 不 同 厂 商 和 型 号 的 网 卡 在 结 构 上 有 所 不 同， 因 此 网 卡 驱 动 程 序 也 是 厂 商 开 发 的 专 用 程 序。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824145042873.png" alt="image-20200824145042873" style="zoom:67%;" />

网 卡 并 不 是 通 上 电 之 后 就 可 以 马 上 开 始 工 作 的， 而 是 和 其 他 硬 件 一 样， 都 需 要 进 行 初 始 化。 也 就 是 说， 打 开 计 算 机 启 动 操 作 系 统 的 时 候， 网 卡 驱 动 程 序 会 对 硬 件 进 行 初 始 化 操 作， 然 后 硬 件 才 进 入 可 以 使 用 的 状 态。 这 些 操 作 包 括 硬 件 错 误 检 查、 初 始 设 置 等 步 骤， 这 些 步 骤 对 于 很 多 其 他 硬 件 也 是 共 通 的， 但 也 有 一 些 操 作 是 以 太 网 特 有 的， 那 就 是 在 控 制 以 太 网 收 发 操 作 的 MAC模 块 中 设 置 MAC 地 址。

网 卡 的 ROM 中 保 存 着 全 世 界 唯 一 的 MAC 地 址， 这 是 在 生 产 网 卡 时 写 入 的， 将 这 个 值 读 出 之 后 就 可 以 对 MAC 模 块 进 行 设 置， MAC 模 块 就 知 道 自 己 对 应 的 MAC 地 址 了。 也 有 一 些 特 殊 的 方 法， 比 如 从 命 令 或 者 配 置 文 件 中 读 取 MAC 地 址 并 分 配 给 MAC 模 块。 这 种 情 况 下， 网 卡 会 忽 略 ROM 中 的 MAC 地 址。 有 人 认 为 在 网 卡 通 电 之 后， ROM 中 的 MAC 地 址 就 自 动 生 效 了， 其 实 不 然， 真 正 生 效 的 是 网 卡 驱 动 进 行 初 始 化 时 在 MAC 模 块 中 设 置 的 那 个 MAC 地 址 84。 在 操 作 系 统 启 动 并 完 成 这 些 初 始 化 操 作 之 后， 网 卡 就 可 以 等 待 来 自 IP 的 委 托 了。



#### 2.5.7 MAC帧

![image-20200824145216830](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200824145216830.png)

首 先， MAC 模 块 会 将 包 从 缓 冲 区 中 取 出， 并 在 开 头 加 上 报 头 和 起 始 帧 分 界 符， 在 末 尾 加 上 用 于 检 测 错 误 的 帧 校 验 序 列。每 个 包 的 前 面 都 有 报 头 和 起 始 帧 分 界 符（ SFD）， 报 头 用 来 测 定 时 机， SFD 用 来 确 定 帧 的 起 始 位 置。

报 头 是 一 串 像 10101010… 这 样 1 和 0 交 替 出 现 的 比 特 序 列， 长 度 为 56 比 特， 它 的 作 用 是 确 定 包 的 读 取 时 机。 

末 尾 的 FCS（ 帧 校 验 序 列） 用 来 检 查 包 传 输 过 程 中 因 噪 声 导 致 的 波 形 紊 乱、 数 据 错 误， 它 是 一 串 32 比 特 的 序 列， 是 通 过 一 个 公 式 对 包 中 从 头 到 尾 的 所 有 内 容 进 行 计 算 而 得 出 来 的。 具 体 的 计 算 公 式 在 此 省 略， 它 和 磁 盘 等 设 备 中 使 用 的 CRC88 错 误 校 验 码 是 同 一 种 东 西， 当 原 始 数 据 中 某 一 个 比 特 发 生 变 化 时， 计 算 出 来 的 结 果 就 会 发 生 变 化。 在 包 传 输 过 程 中， 如 果 受 到 噪 声 的 干 扰 而 导 致 其 中 的 数 据 发 生 了 变 化， 那 么 接 收 方 计 算 出 的 FCS 和 发 送 方 计 算 出 的 FCS 就 会 不 同， 这 样 我 们 就 可 以 判 断 出 数 据 有 没 有 错 误。
