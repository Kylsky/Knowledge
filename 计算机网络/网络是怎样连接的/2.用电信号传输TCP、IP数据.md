## 1.前情提要

第 1 章， 我 们 从 解 析 浏 览 器 中 输 入 的 网 址 开 始， 探 索 了 生 成 HTTP 请 求 消 息、 委 托 操 作 系 统 发 送 消 息 等 步 骤。 本 章， 我 们 将 讲 解 操 作 系 统 中 的 协 议 栈 是 如 何 处 理 数 据 发 送 请 求 的。 第 1 章 介 绍 了 发 送 消 息 的 场 景， 接 下 来 我 们 将 视 角 切 换 到 索 操 作 系 统 中 的 网 络 控 制 软 件（ 协 议 栈） 和 网 络 硬 件 来 继 续 探 索 。

![image-20200817102227078](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102227078.png)



## 2.要点

### 2.1 创建套接字：socket

和 浏 览 器 不 同 的 是， 协 议 栈 的 工 作 我 们 从 表 面 上 是 看 不 见 的， 可 能 比 较 难 以 想 象。 因 此， 在 实 际 探 索 之 前， 我 们 先 来 对 协 议 栈 做 个 解 剖：

协 议 栈 的 内 部 如 图 所 示， 分 为 几 个 部 分， 分 别 承 担 不 同 的 功 能。 这 张 图 中 的 上 下 关 系 是 有 一 定 规 则 的， 上 面 的 部 分 会 向 下 面 的 部 分 委 派 工 作， 下 面 的 部 分 接 受 委 派 的 工 作 并 实 际 执 行， 这 一 点 大 家 在 看 图 时 可 以 参 考 一 下。 当 然， 这 一 上 下 关 系 只 是 一 个 总 体 的 规 则， 其 中 也 有 一 部 分 上 下 关 系 不 明 确， 或 者 上 下 关 系 相 反 的 情 况， 所 以 也 不 必 过 于 纠 结。 此 外， 对 于 图 中 的 每 个 部 分 以 及 它 们 的 工 作 方 式， 本 章 将 按 顺 序 进 行 介 绍， 因 此 对 于 里 面 的 细 节 现 在 看 不 明 白 也 没 关 系， 只 要 大 体 上 看 出 有 哪 些 组 成 要 素 就 可 以 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102702690.png" alt="image-20200817102702690" style="zoom:67%;" />



#### 2.1.1 关于套接字

在 协 议 栈 内 部 有 一 块 用 于 存 放 控 制 信 息 的 内 存 空 间， 这 里 记 录 了 用 于 控 制 通 信 操 作 的 控 制 信 息， 例 如 通 信 对 象 的 IP 地 址、 端 口 号、 通 信 操 作 的 进 行 状 态 等。 本 来 套 接 字 就 只 是 一 个 概 念 而 已， 并 不 存 在 实 体， 如 果 一 定 要 赋 予 它 一 个 实 体， 我 们 可 以 说 这 些 控 制 信 息 就 是 套 接 字 的 实 体， 或 者 说 存 放 控 制 信 息 的 内 存 空 间 就 是 套 接 字 的 实 体。

协 议 栈 在 执 行 操 作 时 需 要 参 阅 这 些 控 制 信 息。 例 如， 在 发 送 数 据 时， 需 要 看 一 看 套 接 字 中 的 通 信 对 象 **IP 地 址** 和 **端 口 号**， 以 便 向 指 定 的 IP 地 址 和 端 口 发 送 数 据。 在 发 送 数 据 之 后， 协 议 栈 需 要 等 待 对 方 返 回 收 到 数 据 的 响 应 信 息， 但 数 据 也 可 能 在 中 途 丢 失， 永 远 也 等 不 到 对 方 的 响 应。 在 这 样 的 情 况 下， 我 们 不 能 一 直 等 下 去， 需 要 在 等 待 一 定 时 间 之 后 重 新 发 送 丢 失 的 数 据， 这 就 需 要 协 议 栈 能 够 知 道 执 行 发 送 数 据 操 作 后 过 了 多 长 时 间。 为 此， 套 接 字 中 必 须 要 记 录 **是 否 已 经 收 到 响 应**， 以 及 发 送 数 据 后 **经 过 了 多 长 时 间**， 才 能 根 据 这 些 信 息 按 照 需 要 执 行 重 发 操 作。

以下是windows上的套接字示例：

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817103910057.png" alt="image-20200817103910057" style="zoom: 67%;" />



#### 2.1.2 调用socket时的操作

在 这 个 过 程 中， 协 议 栈 首 先 会 分 配 用 于 存 放 一 个 套 接 字 所 需 的 内 存 空 间。 用 于 记 录 套 接 字 控 制 信 息 的 内 存 空 间 并 不 是 一 开 始 就 存 在 的， 因 此 我 们 先 要 开 辟 出 这 样 一 块 空 间 来， 这 相 当 于 为 控 制 信 息 准 备 一 个 容 器。 但 光 一 个 容 器 并 没 有 什 么 用， 还 需 要 往 里 面 存 入 控 制 信 息。 套 接 字 刚 刚 创 建 时， 数 据 收 发 操 作 还 没 有 开 始， 因 此 需 要 在 套 接 字 的 内 存 空 间 中 写 入 表 示 这 一 初 始 状 态 的 控 制 信 息。 到 这 里， 创 建 套 接 字 的 操 作 就 完 成 了。

```
计 算 机 内 部 会 同 时 运 行 多 个 程 序， 如 果 每 个 程 序 都 擅 自 使 用 内 存 空 间 的 话， 就 有 可 能 发 生 多 个 程 序 重 复 使 用 同 一 个 内 存 区 域 导 致 数 据 损 坏 的 问 题。 为 了 避 免 出 现 这 样 的 问 题， 操 作 系 统 中 有 一 个“ 内 存 管 理” 模 块， 它 相 当 于 内 存 的 管 理 员， 负 责 根 据 程 序 的 申 请 分 配 相 应 的 内 存 空 间， 并 确 保 这 些 内 存 空 间 不 会 被 其 他 程 序 使 用。 因 此， 分 配 内 存 的 操 作 就 是 向 内 存 管 理 模 块 提 出 申 请， 请 它 划 分 一 块 内 存 空 间 出 来。
```

接 下 来， 需 要 将 表 示 这 个 套 接 字 的 描 述 符 告 知 应 用 程 序。 描 述 符 相 当 于 用 来 区 分 协 议 栈 中 的 多 个 套 接 字 的 号 码 牌。 收 到 描 述 符 之 后， 应 用 程 序 在 向 协 议 栈 进 行 收 发 数 据 委 托 时 就 需 要 提 供 这 个 描 述 符。 由 于 套 接 字 中 记 录 了 通 信 双 方 的 信 息 以 及 通 信 处 于 怎 样 的 状 态， 所 以 只 要 通 过 描 述 符 确 定 了 相 应 的 套 接 字， 协 议 栈 就 能 够 获 取 所 有 的 相 关 信 息， 这 样 一 来， 应 用 程 序 就 不 需 要 每 次 都 告 诉 协 议 栈 应 该 和 谁 进 行 通 信 了。



### 2.2 连接服务器：connect

#### 2.2.1 连接

创 建 套 接 字 之 后， 应 用 程 序（ 浏 览 器） 就 会 调 用 connect， 随 后 协 议 栈 会 将 本 地 的 套 接 字 与 服 务 器 的 套 接 字 进 行 连 接。

套 接 字 刚 刚 创 建 完 成 的 时 候， 里 面 并 没 有 存 放 任 何 数 据， 也 不 知 道 通 信 的 对 象 是 谁。 在 这 个 状 态 下， 即 便 应 用 程 序 要 求 发 送 数 据， 协 议 栈 也 不 知 道 数 据 应 该 发 送 给 谁。 浏 览 器 可 以 根 据 网 址 来 查 询 服 务 器 的 IP 地 址， 而 且 根 据 规 则 也 知 道 应 该 使 用 80 号 端 口， 但 只 有 浏 览 器 知 道 这 些 必 要 的 信 息 是 不 够 的， 因 为 在 调 用 socket 创 建 套 接 字 时， 这 些 信 息 并 没 有 传 递 给 协 议 栈。 因 此， 我 们 需 要 把 服 务 器 的 **IP 地 址** 和 **端 口 号** 等 信 息 告 知 协 议 栈， 这 是 连 接 操 作 的 目 的 之 一。

那 么， 服 务 器 这 边 又 是 怎 样 的 情 况 呢？ 服 务 器 上 也 会 创 建 套 接 字， 但 服 务 器 上 的 协 议 栈 和 客 户 端 一 样， 只 创 建 套 接 字 是 不 知 道 应 该 和 谁 进 行 通 信 的。 而 且， 和 客 户 端 不 同 的 是， 在 服 务 器 上， 连 应 用 程 序 也 不 知 道 通 信 对 象 是 谁， 这 样 下 去 永 远 也 没 法 开 始 通 信。 于 是， 我 们 需 要 让 客 户 端 向 服 务 器 告 知 必 要 的 信 息， 比 如“ 我 想 和 你 开 始 通 信， 我 的 IP 地 址 是 xxx.xxx.xxx.xxx， 端 口 号 是 yyyy。” 可 见， 客 户 端 向 服 务 器 传 达 开 始 通 信 的 请 求， 也 是 连 接 操 作 的 目 的 之 一。



#### 2.2.2 负 责 保 存 控 制 信 息 的 头 部

之 前 我 们 说 的 控 制 信 息 其 实 可 以 大 体 上 分 为 两 类。 

**第 一 类** 是 客 户 端 和 服 务 器 相 互 联 络 时 交 换 的 控 制 信 息。 这 些 信 息 不 仅 连 接 时 需 要， 包 括 数 据 收 发 和 断 开 连 接 操 作 在 内， 整 个 通 信 过 程 中 都 需 要， 这 些 内 容 在 TCP 协 议 的 规 格 中 进 行 了 定 义。 具 体 来 说， 表 中 的 这 些 字 段 就 是 TCP 规 格 中 定 义 的 控 制 信 息 。 这 些 字 段 是 固 定 的， 在 连 接、 收 发、 断 开 等 各 个 阶 段 中， 每 次 客 户 端 和 服 务 器 之 间 进 行 通 信 时， 都 需 要 提 供 这 些 控 制 信 息。

这 些 信 息 会 被 添 加 在 客 户 端 与 服 务 器 之 间 传 递 的 网 络 包 的 开 头。 在 连 接 阶 段， 由 于 数 据 收 发 还 没 有 开 始（要进行三次握手）， 网 络 包 中 没 有 实 际 的 数 据， 只 有 控 制 信 息。 这 些 控 制 信 息 位 于 网 络 包 的 开 头， 因 此 被 称 为 头 部。 此 外， 以 太 网 和 IP 协 议 也 有 自 己 的 控 制 信 息， 这 些 信 息 也 叫 头 部， 为 了 避 免 各 种 不 同 的 头 部 发 生 混 淆， 我 们 一 般 会 记 作 TCP 头 部（传输层)、 以 太 网 头 部 （链路层）、 IP 头 部（网络层）。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193236791.png" alt="image-20200818193236791" style="zoom:67%;" />

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193250728.png" alt="image-20200818193250728" style="zoom:67%;" />

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200818193355430.png" alt="image-20200818193355430" style="zoom:67%;" />

控 制 信 息 还 有 **另 外 一 类**， 那 就 是 保 存 在 套 接 字 中， 用 来 控 制 协 议 栈 操 作 的 信 息。 应 用 程 序 传 递 来 的 信 息 以 及 从 通 信 对 象 接 收 到 的 信 息 都 会 保 存 在 这 里， 还 有 收 发 数 据 操 作 的 执 行 状 态 等 信 息 也 会 保 存 在 这 里， 协 议 栈 会 根 据 这 些 信 息 来 执 行 每 一 步 的 操 作。 我 们 可 以 说， 套 接 字 的 控 制 信 息 和 协 议 栈 的 程 序 本 身 其 实 是 一 体 的， 因 此，“ 协 议 栈 具 体 需 要 哪 些 信 息” 会 根 据 协 议 栈 本 身 的 实 现 方 式 不 同 而 不 同， 但 这 并 没 有 什 么 问 题。 因 为 **协 议 栈 中 的 控 制 信 息 通 信 对 方 是 看 不 见 的**， 只 要 在 通 信 时 按 照 规 则 将 必 要 的 信 息 写 入 头 部， 客 户 端 和 服 务 器 之 间 的 通 信 就 能 够 得 以 成 立。 

例 如， Windows 和 Linux 操 作 系 统 的 内 部 结 构 不 同， 协 议 栈 的 实 现 方 式 不 同， 必 要 的 控 制 信 息 也 就 不 同。 但 即 便 如 此， 两 种 系 统 之 间 依 然 能 够 互 相 通 信， 同 样 地， 计 算 机 和 手 机 之 间 也 能 够 互 相 通 信。 正 如 前 面 所 说， 协 议 栈 的 实 现 不 同， 因 此 我 们 无 法 具 体 说 明 协 议 栈 里 到 底 保 存 了 哪 些 控 制 信 息， 但 可 以 用 命 令 来 显 示 一 些 重 要 的 套 接 字 控 制 信 息，如 下 图。 这 些 信 息 无 论 何 种 操 作 系 统 的 协 议 栈 都 是 共 通 的， 通 过 理 解 这 些 重 要 信 息， 就 能 够 理 解 协 议 栈 的 工 作 方 式 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817103910057.png" alt="image-20200817103910057" style="zoom: 67%;" />



#### 2.2.3 连接操作实际过程

**connect **系 统 调 用 提 供 了 服 务 器 的 IP 地 址 和 端 口 号， 这 些 信 息 会 传 递 给 协 议 栈 中 的 TCP 模 块。 然 后， TCP 模 块 会 与 服 务 器 的 TCP 模 块 交 换 控 制 信 息，如 果 你 正 在 精 心 准 备 一 场 面 试 ，你 会 发 现 这 就 是 在 进 行 TCP的 “ 三 次 握  手”， 这 一 交 互 过 程 包 括 下 面 几 个 步 骤：

**第 一 步**， 客 户 端 先 创 建 一 个 包 含 表 示 开 始 数 据 收 发 操 作 的 控 制 信 息 的 头 部。 头 部 包 含 很 多 字 段， 这 里 要 关 注 的 重 点 是 发 送 方 和 接 收 方 的 端 口 号。 到 这 里， 客 户 端（ 发 送 方） 的 套 接 字 就 准 确 定 位 了 服 务 器（ 接 收 方） 的 套 接 字， 也 就 是 搞 清 楚 了 我 应 该 连 接 哪 个 套 接 字。 然 后， 将 头 部 中 的 控 制 位 的 **SYN 比 特 设 置 为 1**， 可 以 认 为 它 表 示 连 接。 **此 外 还 需 要** 设 置 适 当 的 序 号 和 窗 口 大 小， 这 一 点 我 们 会 稍 后 详 细 讲 解。

**第 二 步**，当 TCP 头 部 创 建 好 之 后， 接 下 来 TCP 模 块 会 将 信 息 传 递 给 IP 模 块 并 委 托 它 进 行 发 送 。 IP 模 块 执 行 网 络 包 发 送 操 作 后， 网 络 包 就 会 通 过 网 络 到 达 服 务 器， 然 后 服 务 器 上 的 IP 模 块 会 将 接 收 到 的 数 据 传 递 给 TCP 模 块， 服 务 器 的 TCP 模 块 根 据 TCP 头 部 中 的 信 息 找 到 端 口 号 对 应 的 套 接 字， 也 就 是 说， 从 处 于 等 待 连 接 状 态 的 套 接 字 中 找 到 与 TCP 头 部 中 记 录 的 端 口 号 相 同 的 套 接 字 就 可 以 了。 当 找 到 对 应 的 套 接 字 之 后， 套 接 字 中 会 写 入 相 应 的 信 息， 并 将 状 态 改 为 正 在 连 接。 上 述 操 作 完 成 后， 服 务 器 的 TCP 模 块 会 返 回 响 应， 这 个 过 程 和 客 户 端 一 样， 需 要 在 TCP 头 部 中 设 置 **发 送 方 和 接 收 方 端 口 号 以 及 SYN 比 特**。 此 外， 在 返 回 响 应 时 还 需 要 将 ACK 控 制 位 设 为 1， 这 表 示 已 经 接 收 到 相 应 的 网 络 包。 网 络 中 经 常 会 发 生 错 误， 网 络 包 也 会 发 生 丢 失， 因 此 双 方 在 通 信 时 必 须 相 互 确 认 网 络 包 是 否 已 经 送 达， 而 设 置 ACK 比 特 就 是 用 来 进 行 这 一 确 认 的。 接 下 来， 服 务 器 TCP 模 块 会 将 TCP 头 部 传 递 给 IP 模 块， 并 委 托 IP 模 块 向 客 户 端 返 回 响 应。

**第 三 步**， 网 络 包 会 返 回 到 客 户 端， 通 过 IP 模 块 到 达 TCP 模 块， 并 通 过 TCP 头 部 的 信 息 确 认 连 接 服 务 器 的 操 作 是 否 成 功。 如 果 SYN 为 1 则 表 示 连 接 成 功， 这 时 会 向 套 接 字 中 写 入 服 务 器 的 IP 地 址、 端 口 号 等 信 息， 同 时 **还 会 将 状 态 改 为 连 接 完 毕**。 到 这 里， 客 户 端 的 操 作 就 已 经 完 成， 但 其 实 还 剩 下 最 后 一 个 步 骤。 刚 才 服 务 器 返 回 响 应 时 将 ACK 比 特 设 置 为 1， 相 应 地， 客 户 端 也 需 要 将 ACK 比 特 设 置 为 1 并 发 回 服 务 器， 告 诉 服 务 器 刚 才 的 响 应 包 已 经 收 到。 当 这 个 服 务 器 收 到 这 个 返 回 包 之 后， 连 接 操 作 才 算 全 部 完 成。 