## 1.前情提要

第 1 章， 我 们 从 解 析 浏 览 器 中 输 入 的 网 址 开 始， 探 索 了 生 成 HTTP 请 求 消 息、 委 托 操 作 系 统 发 送 消 息 等 步 骤。 本 章， 我 们 将 讲 解 操 作 系 统 中 的 协 议 栈 是 如 何 处 理 数 据 发 送 请 求 的。 第 1 章 介 绍 了 发 送 消 息 的 场 景， 接 下 来 我 们 将 视 角 切 换 到 索 操 作 系 统 中 的 网 络 控 制 软 件（ 协 议 栈） 和 网 络 硬 件 来 继 续 探 索 。

![image-20200817102227078](http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102227078.png)



## 2.要点

### 2.1 创建套接字：socket

的。 和 浏 览 器 不 同 的 是， 协 议 栈 的 工 作 我 们 从 表 面 上 是 看 不 见 的， 可 能 比 较 难 以 想 象。 因 此， 在 实 际 探 索 之 前， 我 们 先 来 对 协 议 栈 做 个 解 剖：

协 议 栈 的 内 部 如 图 所 示， 分 为 几 个 部 分， 分 别 承 担 不 同 的 功 能。 这 张 图 中 的 上 下 关 系 是 有 一 定 规 则 的， 上 面 的 部 分 会 向 下 面 的 部 分 委 派 工 作， 下 面 的 部 分 接 受 委 派 的 工 作 并 实 际 执 行， 这 一 点 大 家 在 看 图 时 可 以 参 考 一 下。 当 然， 这 一 上 下 关 系 只 是 一 个 总 体 的 规 则， 其 中 也 有 一 部 分 上 下 关 系 不 明 确， 或 者 上 下 关 系 相 反 的 情 况， 所 以 也 不 必 过 于 纠 结。 此 外， 对 于 图 中 的 每 个 部 分 以 及 它 们 的 工 作 方 式， 本 章 将 按 顺 序 进 行 介 绍， 因 此 对 于 里 面 的 细 节 现 在 看 不 明 白 也 没 关 系， 只 要 大 体 上 看 出 有 哪 些 组 成 要 素 就 可 以 了。

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817102702690.png" alt="image-20200817102702690" style="zoom:67%;" />



#### 2.1.1 关于套接字

在 协 议 栈 内 部 有 一 块 用 于 存 放 控 制 信 息 的 内 存 空 间， 这 里 记 录 了 用 于 控 制 通 信 操 作 的 控 制 信 息， 例 如 通 信 对 象 的 IP 地 址、 端 口 号、 通 信 操 作 的 进 行 状 态 等。 本 来 套 接 字 就 只 是 一 个 概 念 而 已， 并 不 存 在 实 体， 如 果 一 定 要 赋 予 它 一 个 实 体， 我 们 可 以 说 这 些 控 制 信 息 就 是 套 接 字 的 实 体， 或 者 说 存 放 控 制 信 息 的 内 存 空 间 就 是 套 接 字 的 实 体。

协 议 栈 在 执 行 操 作 时 需 要 参 阅 这 些 控 制 信 息。 例 如， 在 发 送 数 据 时， 需 要 看 一 看 套 接 字 中 的 通 信 对 象 **IP 地 址** 和 **端 口 号**， 以 便 向 指 定 的 IP 地 址 和 端 口 发 送 数 据。 在 发 送 数 据 之 后， 协 议 栈 需 要 等 待 对 方 返 回 收 到 数 据 的 响 应 信 息， 但 数 据 也 可 能 在 中 途 丢 失， 永 远 也 等 不 到 对 方 的 响 应。 在 这 样 的 情 况 下， 我 们 不 能 一 直 等 下 去， 需 要 在 等 待 一 定 时 间 之 后 重 新 发 送 丢 失 的 数 据， 这 就 需 要 协 议 栈 能 够 知 道 执 行 发 送 数 据 操 作 后 过 了 多 长 时 间。 为 此， 套 接 字 中 必 须 要 记 录 **是 否 已 经 收 到 响 应**， 以 及 发 送 数 据 后 **经 过 了 多 长 时 间**， 才 能 根 据 这 些 信 息 按 照 需 要 执 行 重 发 操 作。

以下是windows上的套接字示例：

<img src="http://kyle-pic.oss-cn-hangzhou.aliyuncs.com/img/image-20200817103910057.png" alt="image-20200817103910057" style="zoom: 67%;" />



#### 2.1.2 调用socket时的操作

在 这 个 过 程 中， 协 议 栈 首 先 会 分 配 用 于 存 放 一 个 套 接 字 所 需 的 内 存 空 间。 用 于 记 录 套 接 字 控 制 信 息 的 内 存 空 间 并 不 是 一 开 始 就 存 在 的， 因 此 我 们 先 要 开 辟 出 这 样 一 块 空 间 来 12， 这 相 当 于 为 控 制 信 息 准 备 一 个 容 器。 但 光 一 个 容 器 并 没 有 什 么 用， 还 需 要 往 里 面 存 入 控 制 信 息。 套 接 字 刚 刚 创 建 时， 数 据 收 发 操 作 还 没 有 开 始， 因 此 需 要 在 套 接 字 的 内 存 空 间 中 写 入 表 示 这 一 初 始 状 态 的 控 制 信 息。 到 这 里， 创 建 套 接 字 的 操 作 就 完 成 了。

```
计 算 机 内 部 会 同 时 运 行 多 个 程 序， 如 果 每 个 程 序 都 擅 自 使 用 内 存 空 间 的 话， 就 有 可 能 发 生 多 个 程 序 重 复 使 用 同 一 个 内 存 区 域 导 致 数 据 损 坏 的 问 题。 为 了 避 免 出 现 这 样 的 问 题， 操 作 系 统 中 有 一 个“ 内 存 管 理” 模 块， 它 相 当 于 内 存 的 管 理 员， 负 责 根 据 程 序 的 申 请 分 配 相 应 的 内 存 空 间， 并 确 保 这 些 内 存 空 间 不 会 被 其 他 程 序 使 用。 因 此， 分 配 内 存 的 操 作 就 是 向 内 存 管 理 模 块 提 出 申 请， 请 它 划 分 一 块 内 存 空 间 出 来。
```

接 下 来， 需 要 将 表 示 这 个 套 接 字 的 描 述 符 告 知 应 用 程 序。 描 述 符 相 当 于 用 来 区 分 协 议 栈 中 的 多 个 套 接 字 的 号 码 牌。 收 到 描 述 符 之 后， 应 用 程 序 在 向 协 议 栈 进 行 收 发 数 据 委 托 时 就 需 要 提 供 这 个 描 述 符。 由 于 套 接 字 中 记 录 了 通 信 双 方 的 信 息 以 及 通 信 处 于 怎 样 的 状 态， 所 以 只 要 通 过 描 述 符 确 定 了 相 应 的 套 接 字， 协 议 栈 就 能 够 获 取 所 有 的 相 关 信 息， 这 样 一 来， 应 用 程 序 就 不 需 要 每 次 都 告 诉 协 议 栈 应 该 和 谁 进 行 通 信 了。



### 2.2 连接服务器：connect

#### 2.2.1 连接

创 建 套 接 字 之 后， 应 用 程 序（ 浏 览 器） 就 会 调 用 connect， 随 后 协 议 栈 会 将 本 地 的 套 接 字 与 服 务 器 的 套 接 字 进 行 连 接。

套 接 字 刚 刚 创 建 完 成 的 时 候， 里 面 并 没 有 存 放 任 何 数 据， 也 不 知 道 通 信 的 对 象 是 谁。 在 这 个 状 态 下， 即 便 应 用 程 序 要 求 发 送 数 据， 协 议 栈 也 不 知 道 数 据 应 该 发 送 给 谁。 浏 览 器 可 以 根 据 网 址 来 查 询 服 务 器 的 IP 地 址， 而 且 根 据 规 则 也 知 道 应 该 使 用 80 号 端 口， 但 只 有 浏 览 器 知 道 这 些 必 要 的 信 息 是 不 够 的， 因 为 在 调 用 socket 创 建 套 接 字 时， 这 些 信 息 并 没 有 传 递 给 协 议 栈。 因 此， 我 们 需 要 把 服 务 器 的 **IP 地 址** 和 **端 口 号** 等 信 息 告 知 协 议 栈， 这 是 连 接 操 作 的 目 的 之 一。

那 么， 服 务 器 这 边 又 是 怎 样 的 情 况 呢？ 服 务 器 上 也 会 创 建 套 接 字， 但 服 务 器 上 的 协 议 栈 和 客 户 端 一 样， 只 创 建 套 接 字 是 不 知 道 应 该 和 谁 进 行 通 信 的。 而 且， 和 客 户 端 不 同 的 是， 在 服 务 器 上， 连 应 用 程 序 也 不 知 道 通 信 对 象 是 谁， 这 样 下 去 永 远 也 没 法 开 始 通 信。 于 是， 我 们 需 要 让 客 户 端 向 服 务 器 告 知 必 要 的 信 息， 比 如“ 我 想 和 你 开 始 通 信， 我 的 IP 地 址 是 xxx.xxx.xxx.xxx， 端 口 号 是 yyyy。” 可 见， 客 户 端 向 服 务 器 传 达 开 始 通 信 的 请 求， 也 是 连 接 操 作 的 目 的 之 一。



#### 2.2.2 